

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>View Files downloaded using the event log &mdash; MFSQL Connector 4.9.27.69 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/MFSQL-Favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Using the Context Menu" href="../../using-the-context-menu/index.html" />
    <link rel="prev" title="M-Files event log" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> MFSQL Connector
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">FAQ:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">Frequently asked questions</a></li>
</ul>
<p class="caption"><span class="caption-text">MFSQL Connector Guide:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction to MFSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">MFSQL Data Exchange and reporting Connector</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../working-with-metadata/index.html">Working with Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../working-with-class-tables/index.html">Working with Class Tables</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">M-Files event log</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">View Files downloaded using the event log</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#export-the-event-log">Export the event log</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#review-the-result">Review the result</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#analyse-the-events-using-xml-queries">Analyse the events using XML queries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../using-the-context-menu/index.html">Using the Context Menu</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reporting/index.html">Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#m-files-external-connectors">M-Files External Connectors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../mfsql-database-file-connector/index.html">MFSQL Database File Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mfsql-integration-connector/index.html">MFSQL Integration Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../the-connector-framework/index.html">The Connector Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version-control/index.html">Version Control</a></li>
</ul>
<p class="caption"><span class="caption-text">Blog:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../blogs/index.html">List of blogs</a></li>
</ul>
<p class="caption"><span class="caption-text">SQL Components:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../procedures/index.html">Procedures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tables/index.html">Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../functions/index.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../views/index.html">Views</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MFSQL Connector</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">MFSQL Data Exchange and reporting Connector</a> &raquo;</li>
        
          <li><a href="../index.html">M-Files event log</a> &raquo;</li>
        
      <li>View Files downloaded using the event log</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="view-files-downloaded-using-the-event-log">
<h1>View Files downloaded using the event log<a class="headerlink" href="#view-files-downloaded-using-the-event-log" title="Permalink to this headline">¶</a></h1>
<p>This particular use case was focussed on creating a report on when files
where downloaded from M-Files and by whom.</p>
<p>Several MFSQL Connector tables and procedures will come into play:</p>
<ul class="simple">
<li><p>MFEventLog_OpenXML</p></li>
<li><p>MFilesEvents</p></li>
<li><p>spMFGetMfilesLog</p></li>
</ul>
<p>The helper example <strong>17.101.Export and use M-Files event log.sql</strong>
available in the installation folder is used as a starting point.</p>
<hr class="docutils" />
<p>Step 1.</p>
<p>Get the event log from M-Files. This procedure will download the current
event log into SQL in XML format. Set the &#64;ISClearMFilesLog flag to 1
when the procedure is ready to run in unattended mode and it is included
in an SQL agent job.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFGetMfilesLog</span><span class="p">]</span> <span class="o">@</span><span class="n">IsClearMfilesLog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">-- bit  select 1 to delete the log in M-Files</span>
                              <span class="o">@</span><span class="n">Debug</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1">-- small</span>
</pre></div>
</div>
<p>The raw XML export result is in MFEventlog_OpenXML. It is likely that
your SSMS browser will complain when you try to view it. It is also not
very useful to view in this format.</p>
<p><img alt="image0" src="../../../_images/img_111.jpg" /></p>
<p>Rather use the table MFilesEvents. This table is automatically updated
when spMFGetMfilesLog is executed. The table show a listing of each
event, with the event detail as an XML file in the Events column.</p>
<p><img alt="image1" src="../../../_images/img_29.jpg" /></p>
<p>All the downloaded files can be isolate by selecting only events where
type is ‘File downloaded’</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFilesEvents</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mfe</span><span class="p">]</span> <span class="k">WHERE</span> <span class="p">[</span><span class="k">type</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;File downloaded&#39;</span>
</pre></div>
</div>
<p>An example of a XML record for a file download event is below. the XML
record will be different for each type of event.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;event&gt;</span>
  <span class="nt">&lt;id&gt;</span>4314<span class="nt">&lt;/id&gt;</span>
  <span class="nt">&lt;type</span> <span class="na">id=</span><span class="s">&quot;FileAccessed&quot;</span><span class="nt">&gt;</span>File downloaded<span class="nt">&lt;/type&gt;</span>
  <span class="nt">&lt;category</span> <span class="na">id=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>FileAccess<span class="nt">&lt;/category&gt;</span>
  <span class="nt">&lt;timestamp&gt;</span>2018-01-27 06:01:59.778000000<span class="nt">&lt;/timestamp&gt;</span>
  <span class="nt">&lt;causedbyuser</span> <span class="na">loginaccount=</span><span class="s">&quot;Admin&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;data&gt;</span>
    <span class="nt">&lt;objectversion&gt;</span>
      <span class="nt">&lt;objver&gt;</span>
        <span class="nt">&lt;objtype</span> <span class="na">id=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>Document<span class="nt">&lt;/objtype&gt;</span>
        <span class="nt">&lt;objid&gt;</span>477<span class="nt">&lt;/objid&gt;</span>
        <span class="nt">&lt;version&gt;</span>3<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;/objver&gt;</span>
      <span class="nt">&lt;extid</span> <span class="na">extidstatus=</span><span class="s">&quot;Internal&quot;</span><span class="nt">&gt;</span>477<span class="nt">&lt;/extid&gt;</span>
      <span class="nt">&lt;objectguid&gt;</span>{3FAD8281-5A22-42E6-8438-54997C5B0233}<span class="nt">&lt;/objectguid&gt;</span>
      <span class="nt">&lt;versionguid&gt;</span>{B3C69255-9567-430D-821B-A31DBC4FCFDE}<span class="nt">&lt;/versionguid&gt;</span>
      <span class="nt">&lt;objectflags</span> <span class="na">value=</span><span class="s">&quot;64&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;objectflag</span> <span class="na">id=</span><span class="s">&quot;64&quot;</span><span class="nt">&gt;</span>normal<span class="nt">&lt;/objectflag&gt;</span>
      <span class="nt">&lt;/objectflags&gt;</span>
      <span class="nt">&lt;originalobjid&gt;</span>
        <span class="nt">&lt;vault&gt;</span>{C840BE1A-5B47-4AC0-8EF7-835C166C8E24}<span class="nt">&lt;/vault&gt;</span>
        <span class="nt">&lt;objtype&gt;</span>0<span class="nt">&lt;/objtype&gt;</span>
        <span class="nt">&lt;id&gt;</span>477<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;/originalobjid&gt;</span>
      <span class="nt">&lt;title&gt;</span>Reseller Agreement - DAT Sports <span class="ni">&amp;amp;</span> Entertainment (11/2000)<span class="nt">&lt;/title&gt;</span>
      <span class="nt">&lt;displayid&gt;</span>477<span class="nt">&lt;/displayid&gt;</span>
    <span class="nt">&lt;/objectversion&gt;</span>
    <span class="nt">&lt;filename&gt;</span>Reseller Agreement - DAT Sports <span class="ni">&amp;amp;</span> Entertainment (11_2000).pdf<span class="nt">&lt;/filename&gt;</span>
  <span class="nt">&lt;/data&gt;</span>
<span class="nt">&lt;/event&gt;</span>
</pre></div>
</div>
<p>Extracting the XML values into a temporary table and join it with other
tables to prepare the reporting data to show when the user has
downloaded the file. The XML part of the statement will different,
depending on the type of event.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="n">ID</span><span class="p">],</span>
       <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="n">Category</span><span class="p">],</span>
       <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="k">Type</span><span class="p">],</span>
       <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="n">CausedByUser</span><span class="p">],</span>
       <span class="p">[</span><span class="n">ml</span><span class="p">].[</span><span class="n">FullName</span><span class="p">],</span>
       <span class="p">[</span><span class="n">ml</span><span class="p">].[</span><span class="n">EmailAddress</span><span class="p">],</span>
       <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="k">TimeStamp</span><span class="p">],</span>
       <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="n">Events</span><span class="p">].[</span><span class="n">value</span><span class="p">](</span><span class="s1">&#39;(/event/data/objectversion/title)[1]&#39;</span><span class="p">,</span> <span class="s1">&#39;varchar(100)&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="p">[</span><span class="n">NameOrTitle</span><span class="p">],</span>
       <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="n">Events</span><span class="p">].[</span><span class="n">value</span><span class="p">](</span><span class="s1">&#39;(/event/data/filename)[1]&#39;</span><span class="p">,</span> <span class="s1">&#39;varchar(100)&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="p">[</span><span class="n">FileName</span><span class="p">],</span>
       <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="n">Events</span><span class="p">].[</span><span class="n">value</span><span class="p">](</span><span class="s1">&#39;(/event/data/objectversion/objver/objtype/@id)[1]&#39;</span><span class="p">,</span> <span class="s1">&#39;varchar(100)&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="p">[</span><span class="n">ObjectType_ID</span><span class="p">],</span>
       <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="n">Events</span><span class="p">].[</span><span class="n">value</span><span class="p">](</span><span class="s1">&#39;(/event/data/objectversion/objver/objtype)[1]&#39;</span><span class="p">,</span> <span class="s1">&#39;varchar(100)&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="p">[</span><span class="n">ObjectType</span><span class="p">],</span>
       <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="n">Events</span><span class="p">].[</span><span class="n">value</span><span class="p">](</span><span class="s1">&#39;(/event/data/objectversion/objver/objid)[1]&#39;</span><span class="p">,</span> <span class="s1">&#39;varchar(100)&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="p">[</span><span class="n">Objid</span><span class="p">]</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFilesEvents</span><span class="p">]</span> <span class="p">[</span><span class="n">me</span><span class="p">]</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFLoginAccount</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">ml</span><span class="p">]</span>
        <span class="k">ON</span> <span class="p">[</span><span class="n">ml</span><span class="p">].[</span><span class="n">AccountName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="n">CausedByUser</span><span class="p">]</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFUserAccount</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mua</span><span class="p">]</span>
        <span class="k">ON</span> <span class="p">[</span><span class="n">ml</span><span class="p">].[</span><span class="n">MFID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mua</span><span class="p">].[</span><span class="n">UserID</span><span class="p">]</span>
<span class="k">WHERE</span> <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="n">Category</span><span class="p">]</span> <span class="k">IN</span> <span class="p">(</span> <span class="s1">&#39;FileAccess&#39;</span><span class="p">,</span> <span class="s1">&#39;PublicLink&#39;</span> <span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="p">[</span><span class="n">me</span><span class="p">].[</span><span class="k">TimeStamp</span><span class="p">]</span> <span class="k">DESC</span>
</pre></div>
</div>
<p>Various categories and types apply to file download operations. Include
these in the filter of the statement.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 65%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Category</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Public link created
Public link accessed
File downloaded via public link
File downloaded</p></td>
<td><p>PublicLink
PublicLink
FileAccess
FileAccess</p></td>
</tr>
</tbody>
</table>
<p>Example of extract based on the statement above</p>
<p><img alt="image2" src="../../../_images/img_34.jpg" /></p>
<p><img alt="image3" src="../../../_images/img_34.jpg" /></p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../using-the-context-menu/index.html" class="btn btn-neutral float-right" title="Using the Context Menu" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral float-left" title="M-Files event log" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Laminin Solutions Ltd

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>