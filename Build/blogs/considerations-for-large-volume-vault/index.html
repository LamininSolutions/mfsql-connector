

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Considerations for large volume vault &mdash; MFSQL Connector 4.9.27.69 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/MFSQL-Favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Create a scheduled pull from M-Files using SQL Server Agent" href="../create-a-scheduled-pull-from-m-files-using-sql-server-agent/index.html" />
    <link rel="prev" title="Considerations for deleted records" href="../considerations-for-deleted-records/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> MFSQL Connector
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">FAQ:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Frequently asked questions</a></li>
</ul>
<p class="caption"><span class="caption-text">MFSQL Connector Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction to MFSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-data-exchange-and-reporting-connector/index.html">MFSQL Data Exchange and reporting Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-database-file-connector/index.html">MFSQL Database File Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-integration-connector/index.html">MFSQL Integration Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../the-connector-framework/index.html">The Connector Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../version-control/index.html">Version Control</a></li>
</ul>
<p class="caption"><span class="caption-text">Blog:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">List of blogs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../advanced-updating-of-valuelists-from-external-source/index.html">Advanced updating of Valuelists from external source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../align-metadata-from-an-external-source-with-data-in-m-files/index.html">Align metadata from an external source with data in M-Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aligning-valuelist-items-with-different-owners/index.html">Aligning valuelist items with different owners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../building-applications-around-m-files/index.html">Building applications around M-Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../certified-application-developer-presentation/index.html">Certified Application Developer presentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changing-class-of-object/index.html">Changing the class of an object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changing-from-single-lookup-to-multi-lookup/index.html">Changing from single lookup to multi lookup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../considerations-for-deleted-records/index.html">Considerations for deleted records</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Considerations for large volume vault</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initialize-class-table">Initialize class table</a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-with-recent-changes">Update with recent changes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#spmfupdatetable">spMFUpdateTable</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spmfupdatetablewithlastmodifieddate">spMFUpdateTableWithLastModifiedDate</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spmfupdatemfilestosql">spMFUpdateMfilesToSQL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#update-from-sql-to-m-files">Update from SQL to M-Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#validating-class-table">Validating class table</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#spmftableaudit">spMFTableAudit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spmfgetobjectvers">spMFGetObjectvers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#benchmarks-with-large-volume-test-results">Benchmarks with large volume test results.</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../create-a-scheduled-pull-from-m-files-using-sql-server-agent/index.html">Create a scheduled pull from M-Files using SQL Server Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../creating-and-using-public-shared-link/index.html">Creating and using public shared link</a></li>
<li class="toctree-l2"><a class="reference internal" href="../creating-multiple-related-objects-on-file-import/index.html">Creating multiple related objects on file import</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crm-and-emailer-management/index.html">CRM and Emailer Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deleting-duplicate-objects/index.html">Deleting duplicate objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explore-object-versions/index.html">Explore Object History Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extended-reporting/index.html">Extended Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../externalid-displayid-objid/index.html">ExternalID versus DisplayID versus Objid</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-all-objects-in-vault/index.html">Explore all the objects in the vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-number-of-records-in-class/index.html">Get number of records in Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-objectchangehistory/index.html">Working with object change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started-with-a-custom-application/index.html">Getting started with a custom application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-to-know-mfsql-connector/index.html">Getting to know MFSQL Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto-quick-follow-up-list/index.html">How to generate a quick follow up list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../illegal-xml-characters/index.html">Illegal XML Characters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../import-files-into-m-files-from-explorer/index.html">Import files into M-Files from explorer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../importing-files-from-a-database/index.html">Importing files from a database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../insert-new-records-from-sql/index.html">Insert new records from SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-whitepaper/index.html">Integration whitepaper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-sage-200---case-management/index.html">Integration with SAGE 200 - Case Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-sage-50/index.html">Integration with SAGE 50</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-test-equipment/index.html">Integration with test equipment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-vendor-management-and-purchasing-with-epicor-enterprise/index.html">Integration with Vendor Management and Purchasing with Epicor Enterprise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mark-for-archiving-using-class-table/index.html">Mark for Archiving using Class Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata-management/index.html">Metadata Management and data cleansing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata_management_and_realignment/index.html">Metadata Management and Realignment Case Study</a></li>
<li class="toctree-l2"><a class="reference internal" href="../moving-documents-from-one-class-to-another/index.html">Moving documents from one class to another</a></li>
<li class="toctree-l2"><a class="reference internal" href="../moving-metadata-from-text-properties-to-valuelist-items/index.html">Moving metadata from text properties to Valuelist items</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multiselectlookups/index.html">MultiSelectLookups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../near-real-time-reporting/index.html">Near real time reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../online-ordering-of-special-stock/index.html">Online Ordering of special stock</a></li>
<li class="toctree-l2"><a class="reference internal" href="../online-quote-system/index.html">Online Quote System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing-scanned-documents/index.html">Processing scanned documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../properties-with-multi-lookup-datatypes/index.html">Properties with multi lookup datatypes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../real-datatype/index.html">Limitations of real datatype</a></li>
<li class="toctree-l2"><a class="reference internal" href="../report-designers-and-the-connector/index.html">Report designers and the Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reports-from-the-extended-event-log/index.html">Reports from the extended Event log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../restore-to-a-different-database/index.html">Restore MFSQL database to a different server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rpc-over-https/index.html">RPC over HTTPS setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setting-up-a-workflow-state-change/index.html">Setting up a workflow state change</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setup-agent-proxy/index.html">Setup Agent Proxy for MFSQLConnect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../status-report-using-context-menu/index.html">Status report using context menu</a></li>
<li class="toctree-l2"><a class="reference internal" href="../table-relations---views-for-reporting/index.html">Table relations - views for reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../update-large-tables/index.html">Update large tables using batch mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-a-multi-lookup-property-on-an-object/index.html">Updating a multi lookup property on an object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-incorrect-properties-across-multiple-related-classes/index.html">Updating incorrect properties across multiple related classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-only-records-that-changed/index.html">Updating only records that changed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating_millions_of_records/index.html">Updating millions of records</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-delimiter-functions/index.html">Using delimiter functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-event-handler-for-sql-action/index.html">Using event handler for SQL action</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-hyperlinks-with-mfsql-connector/index.html">Using hyperlinks with MFSQL Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-m-files-external-connector/index.html">Using M-Files External Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-object-change-history-to-report-on-state-changes/index.html">Using object change history to report on state changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-spmfclasstablestats/index.html">Using spMFClassTableStats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-the-external_id-to-match-third-party-app-tables/index.html">Using the External_ID to match third party app tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../windows-authentication/index.html">Using windows authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_checkedout/index.html">Working with checkedOut objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_dates/index.html">Working with date and time</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_document_collections/index.html">Working with Document Collections</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">SQL Components:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../procedures/index.html">Procedures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tables/index.html">Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../functions/index.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../views/index.html">Views</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MFSQL Connector</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">List of blogs</a> &raquo;</li>
        
      <li>Considerations for large volume vault</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="considerations-for-large-volume-vault">
<h1>Considerations for large volume vault<a class="headerlink" href="#considerations-for-large-volume-vault" title="Permalink to this headline">¶</a></h1>
<p>The demand for managing metadata in large vaults is on the increase.
MFSQL Connector can make a difference when the most appropriate tools
are selected to deal with different scenarios and applications. This
blog aims at providing perspective on the key considerations for large
vaults.</p>
<p>The number of objects and the complexity of the metadata design in a
specific class is key to define a “large vault” in terms of the use and
impact of MFSQL Connector. Anything over 75,000 records should be
regarded as large volume and should take these considerations into
account.</p>
<p>Running spMFUpdateTable in default mode with no filters will fail with
large volumes. The XML files being transferred in the process are simply
too large.</p>
<p>There are other options, and the options to use will depend on the use
case.</p>
<ol class="arabic simple">
<li><p>Initialize class table</p></li>
<li><p>Update class table with recent changes</p></li>
<li><p>Update M-Files from SQL</p></li>
<li><p>Validate class table</p></li>
</ol>
<div class="section" id="initialize-class-table">
<h2>Initialize class table<a class="headerlink" href="#initialize-class-table" title="Permalink to this headline">¶</a></h2>
<p>The first pull or initialization of the class table will take some time.
As an example, our benchmark with 545000 records took approx 6 hours to
complete. The procedure spmfUpdateTableInBatches must be used.</p>
<p>This procedure may also be used to validate or re-initialise a class
table.</p>
<p>Set the &#64;ToObjid parameter to the maximum segment id for the object
type. The procedure will update the class table in batches until it
reaches the maximum. It is also possible to update specific segments by
specifying the &#64;FromObjid and &#64;ToObjid.</p>
<p>The estimated processing time can be calculated : max segment id / 500
* 24 / 60 / 60 = number of hours for update. in this formula the 500 is
the fixed size of the batches and the 24 is the average processing time
in seconds per batch. The &#64;WithStats parameter will allow you to see the
progress of processing in SSMS.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">exec</span> <span class="n">spMFUpdateTableinBatches</span>
<span class="o">@</span><span class="n">MFtableName</span> <span class="o">=</span> <span class="s1">&#39;MFLargeClassTable&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">UpdateMethod</span> <span class="o">=</span><span class="mi">1</span>
<span class="p">,</span><span class="o">@</span><span class="n">WithTableAudit</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">,</span><span class="o">@</span><span class="n">FromObjid</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">,</span><span class="o">@</span><span class="n">ToObjid</span> <span class="o">=</span> <span class="mi">600000</span>
<span class="p">,</span><span class="o">@</span><span class="n">WithStats</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p><img alt="image0" src="../../_images/img_1.png" /></p>
</div>
<div class="section" id="update-with-recent-changes">
<h2>Update with recent changes<a class="headerlink" href="#update-with-recent-changes" title="Permalink to this headline">¶</a></h2>
<p>Regular update of the class table has two scenarios:</p>
<ul class="simple">
<li><p>update records where the objid is known</p></li>
<li><p>update all records since last change in M-Files</p></li>
<li><p>update all changed records including deletions in M-Files.</p></li>
</ul>
<div class="section" id="spmfupdatetable">
<h3>spMFUpdateTable<a class="headerlink" href="#spmfupdatetable" title="Permalink to this headline">¶</a></h3>
<p>Using spMFUpdateTable with parameter &#64;Objids referencing the objid or
list of objid’s to be update is highly efficient in large volume class
table updates.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFUpdateTable</span><span class="p">]</span> <span class="o">@</span><span class="n">MFTableName</span> <span class="o">=</span> <span class="s1">&#39;MFLarge_Volume&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">UpdateMethod</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">,</span><span class="o">@</span><span class="n">ObjIDs</span> <span class="o">=</span> <span class="s1">&#39;80184,80313&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="spmfupdatetablewithlastmodifieddate">
<h3>spMFUpdateTableWithLastModifiedDate<a class="headerlink" href="#spmfupdatetablewithlastmodifieddate" title="Permalink to this headline">¶</a></h3>
<p>Using spmfUpdateTableWithLastModifiedDate will get all records from
M-Files which has changes since the last update of the class table. Use
this procedure as the default approach when the objid of the records to
be updated is unknown. Records deleted in M-Files is however NOT
identified with this procedure.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DECLARE</span> <span class="o">@</span><span class="n">Return_LastModified</span> <span class="n">DATETIME</span>
       <span class="p">,</span><span class="o">@</span><span class="n">Update_IDOut</span>        <span class="nb">INT</span>
       <span class="p">,</span><span class="o">@</span><span class="n">ProcessBatch_ID1</span>    <span class="nb">INT</span><span class="p">;</span>

<span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFUpdateTableWithLastModifiedDate</span><span class="p">]</span> <span class="o">@</span><span class="n">UpdateMethod</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">,</span><span class="o">@</span><span class="n">Return_LastModified</span> <span class="o">=</span> <span class="o">@</span><span class="n">Return_LastModified</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">TableName</span> <span class="o">=</span> <span class="s1">&#39;MFLarge_Volume&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">Update_IDOut</span> <span class="o">=</span> <span class="o">@</span><span class="n">Update_IDOut</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="o">=</span> <span class="o">@</span><span class="n">ProcessBatch_ID1</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div>
</div>
<p>Our Benchmark show the update of a single record change in M-Files to
class with 545000 records took approx 5 seconds.</p>
</div>
<div class="section" id="spmfupdatemfilestosql">
<h3>spMFUpdateMfilesToSQL<a class="headerlink" href="#spmfupdatemfilestosql" title="Permalink to this headline">¶</a></h3>
<p>Using spMFUpdateMFilesToSQL is very efficient to get changed object
versions using spMFTableAudit, and then to update the class table by
only processing the changed objects. This elliminates exchanging large
datasets between M-Files and SQL to determine which records had changed.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>  <span class="k">DECLARE</span> <span class="o">@</span><span class="n">MFLastUpdateDate</span> <span class="n">SMALLDATETIME</span>
       <span class="p">,</span><span class="o">@</span><span class="n">Update_IDOut</span>     <span class="nb">INT</span>
       <span class="p">,</span><span class="o">@</span><span class="n">ProcessBatch_ID</span>  <span class="nb">INT</span><span class="p">;</span>

<span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFUpdateMFilesToMFSQL</span><span class="p">]</span> <span class="o">@</span><span class="n">MFTableName</span> <span class="o">=</span> <span class="s1">&#39;MFLarge_volume&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">MFLastUpdateDate</span> <span class="o">=</span> <span class="o">@</span><span class="n">MFLastUpdateDate</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">UpdateTypeID</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">-- tinyint</span>
<span class="p">,</span><span class="o">@</span><span class="n">Update_IDOut</span> <span class="o">=</span> <span class="o">@</span><span class="n">Update_IDOut</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="o">=</span> <span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>A single record that has changed takes approx 4 seconds to update in a class table with 545 000 objects.</p>
</div>
</div>
<div class="section" id="update-from-sql-to-m-files">
<h2>Update from SQL to M-Files<a class="headerlink" href="#update-from-sql-to-m-files" title="Permalink to this headline">¶</a></h2>
<p>Updating updates from SQL to M-Files with large tables have two
considerations.</p>
<p>When update a smallish (a couple of thousand) entries into the large
volume table, the standard spMFUpdatTable with &#64;UpdateMethod = 0 can we
used. Updating 6 records from SQL to M-Files took 39 seconds in our
benchmark.</p>
<p>We recommend to use spMFUpdateTableInBatches with &#64;UpdateMethod = 0 when
a large number of records is being updated. This is particularly
relevant when say all the records in the class table has been changed in
SQL and need updating into M-Files. Updating M-Files from SQL is a
particularly slow operation as each record need to be checked out,
updated and checked back in. Our benchmarks has shown that it takes
approx 75 seconds for each batch of 500 to be update. Updating all 545
000 records took approx 21 hours. The benefit of using the batch update
method is that each batch processed can be monitored separately and if
something happens, the process can be abandoned and restarted.</p>
</div>
<div class="section" id="validating-class-table">
<h2>Validating class table<a class="headerlink" href="#validating-class-table" title="Permalink to this headline">¶</a></h2>
<p>The class table should always reflect the status of M-Files objects up
to the last pull from M-Files. The Connector include procedures that is
specifically geared towards validating this is the case.</p>
<div class="section" id="spmftableaudit">
<h3>spMFTableAudit<a class="headerlink" href="#spmftableaudit" title="Permalink to this headline">¶</a></h3>
<p>The spMFTableAudit procedure creates a separate table MFAuditHistory of
the object version of the class. Executing this procedure will pull all
the object versions (objid, version, class, object type) and compare it
with the associated class table and flag each objid status.</p>
<p>This procedure can be executed to do a full comparison, or to only pull
object versions that changed from a certain date.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DECLARE</span> <span class="o">@</span><span class="n">SessionIDOut</span>    <span class="nb">INT</span>
       <span class="p">,</span><span class="o">@</span><span class="n">NewObjectXml</span>    <span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span>
       <span class="p">,</span><span class="o">@</span><span class="n">DeletedInSQL</span>    <span class="nb">INT</span>
       <span class="p">,</span><span class="o">@</span><span class="n">UpdateRequired</span>  <span class="nb">BIT</span>
       <span class="p">,</span><span class="o">@</span><span class="n">OutofSync</span>       <span class="nb">INT</span>
       <span class="p">,</span><span class="o">@</span><span class="n">ProcessErrors</span>   <span class="nb">INT</span>
       <span class="p">,</span><span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="nb">INT</span><span class="p">;</span>

<span class="k">DECLARE</span>     <span class="o">@</span><span class="n">MFModifiedDate</span> <span class="n">DATETIME</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="n">MFModifiedDate</span> <span class="o">=</span> <span class="k">MAX</span><span class="p">([</span><span class="n">mlv</span><span class="p">].[</span><span class="n">MF_Last_Modified</span><span class="p">])</span> <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFLarge_volume</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mlv</span><span class="p">]</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="n">MFModifiedDate</span> <span class="o">=</span> <span class="k">ISNULL</span><span class="p">(</span><span class="o">@</span><span class="n">MFModifiedDate</span><span class="p">,</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">)</span>

<span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFTableAudit</span><span class="p">]</span> <span class="o">@</span><span class="n">MFTableName</span> <span class="o">=</span> <span class="s1">&#39;MFLarge_Volume&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">MFModifiedDate</span> <span class="o">=</span> <span class="o">@</span><span class="n">MFModifiedDate</span>
<span class="p">,</span><span class="o">@</span><span class="n">SessionIDOut</span> <span class="o">=</span> <span class="o">@</span><span class="n">SessionIDOut</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">NewObjectXml</span> <span class="o">=</span> <span class="o">@</span><span class="n">NewObjectXml</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">DeletedInSQL</span> <span class="o">=</span> <span class="o">@</span><span class="n">DeletedInSQL</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">UpdateRequired</span> <span class="o">=</span> <span class="o">@</span><span class="n">UpdateRequired</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">OutofSync</span> <span class="o">=</span> <span class="o">@</span><span class="n">OutofSync</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">ProcessErrors</span> <span class="o">=</span> <span class="o">@</span><span class="n">ProcessErrors</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="o">=</span> <span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">Debug</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Use the view MFvwAuditSummary to provide a quick overview of the result</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFvwAuditSummary</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mfas</span><span class="p">]</span>
<span class="k">WHERE</span> <span class="p">[</span><span class="n">mfas</span><span class="p">].[</span><span class="n">TableName</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MFLarge_Volume&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="spmfgetobjectvers">
<h3>spMFGetObjectvers<a class="headerlink" href="#spmfgetobjectvers" title="Permalink to this headline">¶</a></h3>
<p>This procedure is used in spMFTableAudit. However, applying it on its
own is effective to return objects in the class table that has changed
since the last update.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DECLARE</span> <span class="o">@</span><span class="n">outPutXML</span>       <span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span>
        <span class="p">,</span><span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="nb">INT</span><span class="p">;</span>

<span class="k">DECLARE</span> <span class="o">@</span><span class="n">lastmodified</span> <span class="n">DATETIME</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">Idoc</span> <span class="nb">int</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="n">lastmodified</span> <span class="o">=</span> <span class="k">MAX</span><span class="p">([</span><span class="n">mbs</span><span class="p">].[</span><span class="n">MF_Last_Modified</span><span class="p">])</span> <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFBasic_singleprop</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mbs</span><span class="p">]</span>

<span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFGetObjectvers</span><span class="p">]</span> <span class="o">@</span><span class="n">TableName</span> <span class="o">=</span> <span class="s1">&#39;MFlarge_Volume&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">dtModifiedDate</span> <span class="o">=</span> <span class="o">@</span><span class="n">lastmodified</span>
<span class="p">,</span><span class="o">@</span><span class="n">MFIDs</span> <span class="o">=</span> <span class="s1">&#39;550000&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">outPutXML</span> <span class="o">=</span> <span class="o">@</span><span class="n">outPutXML</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="o">=</span> <span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="k">OUTPUT</span>
<span class="p">,</span><span class="o">@</span><span class="n">Debug</span> <span class="o">=</span> <span class="mi">0</span>



<span class="k">EXEC</span> <span class="p">[</span><span class="n">sys</span><span class="p">].[</span><span class="n">sp_xml_preparedocument</span><span class="p">]</span> <span class="o">@</span><span class="n">Idoc</span> <span class="k">OUTPUT</span><span class="p">,</span> <span class="o">@</span><span class="n">outPutXML</span><span class="p">;</span>

    <span class="k">WITH</span> <span class="p">[</span><span class="n">cte</span><span class="p">]</span>
    <span class="k">AS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="p">[</span><span class="n">xmlfile</span><span class="p">].[</span><span class="n">objId</span><span class="p">]</span>
              <span class="p">,[</span><span class="n">xmlfile</span><span class="p">].[</span><span class="n">MFVersion</span><span class="p">]</span>
              <span class="p">,[</span><span class="n">xmlfile</span><span class="p">].[</span><span class="n">GUID</span><span class="p">]</span>
              <span class="p">,[</span><span class="n">xmlfile</span><span class="p">].[</span><span class="n">ObjectType_ID</span><span class="p">]</span>
        <span class="k">FROM</span>
            <span class="n">OPENXML</span><span class="p">(</span><span class="o">@</span><span class="n">Idoc</span><span class="p">,</span> <span class="s1">&#39;/form/objVers&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">WITH</span>
            <span class="p">(</span>
                <span class="p">[</span><span class="n">objId</span><span class="p">]</span> <span class="nb">INT</span> <span class="s1">&#39;./@objectID&#39;</span>
               <span class="p">,[</span><span class="n">MFVersion</span><span class="p">]</span> <span class="nb">INT</span> <span class="s1">&#39;./@version&#39;</span>
               <span class="p">,[</span><span class="n">GUID</span><span class="p">]</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="s1">&#39;./@objectGUID&#39;</span>
               <span class="p">,[</span><span class="n">ObjectType_ID</span><span class="p">]</span> <span class="nb">INT</span> <span class="s1">&#39;./@objectType&#39;</span>
            <span class="p">)</span> <span class="p">[</span><span class="n">xmlfile</span><span class="p">])</span>
   <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">cte</span>

  <span class="k">EXEC</span> <span class="p">[</span><span class="n">sys</span><span class="p">].[</span><span class="n">sp_xml_removedocument</span><span class="p">]</span> <span class="o">@</span><span class="n">Idoc</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="benchmarks-with-large-volume-test-results">
<h2>Benchmarks with large volume test results.<a class="headerlink" href="#benchmarks-with-large-volume-test-results" title="Permalink to this headline">¶</a></h2>
<p>Benchmarks are generated on separate SQL and M-Files servers; SQL 2017
Standard Edition with 8GB memory. The tests where done one after the
other and not concurrently. No additional vault applications (such as
compliance kit, metadata configuration validation etc) are running.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 39%" />
<col style="width: 7%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Scenario</p></th>
<th class="head"><p>Record count</p></th>
<th class="head"><p>Benchmark</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>spMFUpdateTable
This procedure should not be used without filters for large volume updates</p></td>
<td><p>No special filters
Initialization of table records in M-Files but not in Class Table
class table is empty at start</p></td>
<td><p>545640</p></td>
<td><p>Fails</p></td>
</tr>
<tr class="row-odd"><td><p>spMFUpdateTableInBatches
&#64;WithTableAudit = 0
&#64;ToObjid = 550000</p></td>
<td><p>Initialization table with empty class table and table audit not processed
in advance records in M-Files but not in Class Table</p></td>
<td><p>545640</p></td>
<td><p>all items updated in SQL
6:07:10
Ave 24 sec per batch</p></td>
</tr>
<tr class="row-even"><td><p>spMFUpdateTableWithLastModifiedDate</p></td>
<td><p>Change one record in M-Files
Class table was updated before change</p></td>
<td><p>545640</p></td>
<td><p>00:00:05</p></td>
</tr>
<tr class="row-odd"><td><p>spMFUpdateTable
&#64;Objids = ‘00184,80143’</p></td>
<td><p>Change two records in M-Files
The latest version of two records are update in SQL</p></td>
<td><p>545640</p></td>
<td><p>2 records updated
00:00:09</p></td>
</tr>
<tr class="row-even"><td><p>spMFUpdateTable
&#64;UpdateMethod - 0</p></td>
<td><p>Changing records in SQL and updating the records into M-Files</p></td>
<td><p>545 636</p></td>
<td><p>6 records changed
00:00:39</p></td>
</tr>
<tr class="row-odd"><td><p>spMFUpdateMfilestoSQL
&#64;UpdateTypeID = 1
(incremental update)</p></td>
<td><p>Change one record in M-Files and update SQL
However, in this case another record was changed previously. This has
been identified because the procedure get all changed Object Versions
before it processes the record.
90% of the run time relates to spMFTableAudit for records changed after
the last class update.</p></td>
<td><p>545 640
1 update</p></td>
<td><p>records updated: 1
00:00:04</p></td>
</tr>
<tr class="row-even"><td><p>spMFTableAudit
&#64;MFModifiedDate = max of lastmodified in class table</p></td>
<td><p>Change one record in MF</p></td>
<td><p>545 640
2 update</p></td>
<td><p>records updated: 2
00:00:05</p></td>
</tr>
<tr class="row-odd"><td><p>spMFUpdateTableInBatches
&#64;updatemethod = 0</p></td>
<td><p>set process_id for 11490 records to 1
11490 records to update</p></td>
<td><p>545 640
11490 update</p></td>
<td><p>00:29:32</p></td>
</tr>
<tr class="row-even"><td><p>spMFTableAudit
&#64;MFModifiedDate = null</p></td>
<td><p>Full refresh of audit history</p></td>
<td><p>545 640</p></td>
<td><p>records updated: 545 640
00:35:35</p></td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../create-a-scheduled-pull-from-m-files-using-sql-server-agent/index.html" class="btn btn-neutral float-right" title="Create a scheduled pull from M-Files using SQL Server Agent" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../considerations-for-deleted-records/index.html" class="btn btn-neutral float-left" title="Considerations for deleted records" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Laminin Solutions Ltd

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>