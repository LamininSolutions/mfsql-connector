

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Setting up a workflow state change &mdash; MFSQL Connector 4.9.27.69 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/MFSQL-Favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Setup Agent Proxy for MFSQLConnect" href="../setup-agent-proxy/index.html" />
    <link rel="prev" title="RPC over HTTPS setup" href="../rpc-over-https/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> MFSQL Connector
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">FAQ:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Frequently asked questions</a></li>
</ul>
<p class="caption"><span class="caption-text">MFSQL Connector Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction to MFSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-data-exchange-and-reporting-connector/index.html">MFSQL Data Exchange and reporting Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-database-file-connector/index.html">MFSQL Database File Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-integration-connector/index.html">MFSQL Integration Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../the-connector-framework/index.html">The Connector Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../version-control/index.html">Version Control</a></li>
</ul>
<p class="caption"><span class="caption-text">Blog:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">List of blogs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../advanced-updating-of-valuelists-from-external-source/index.html">Advanced updating of Valuelists from external source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../align-metadata-from-an-external-source-with-data-in-m-files/index.html">Align metadata from an external source with data in M-Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aligning-valuelist-items-with-different-owners/index.html">Aligning valuelist items with different owners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../building-applications-around-m-files/index.html">Building applications around M-Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../certified-application-developer-presentation/index.html">Certified Application Developer presentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changing-class-of-object/index.html">Changing the class of an object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changing-from-single-lookup-to-multi-lookup/index.html">Changing from single lookup to multi lookup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../considerations-for-deleted-records/index.html">Considerations for deleted records</a></li>
<li class="toctree-l2"><a class="reference internal" href="../considerations-for-large-volume-vault/index.html">Considerations for large volume vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="../create-a-scheduled-pull-from-m-files-using-sql-server-agent/index.html">Create a scheduled pull from M-Files using SQL Server Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../creating-and-using-public-shared-link/index.html">Creating and using public shared link</a></li>
<li class="toctree-l2"><a class="reference internal" href="../creating-multiple-related-objects-on-file-import/index.html">Creating multiple related objects on file import</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crm-and-emailer-management/index.html">CRM and Emailer Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deleting-duplicate-objects/index.html">Deleting duplicate objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explore-object-versions/index.html">Explore Object History Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extended-reporting/index.html">Extended Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../externalid-displayid-objid/index.html">ExternalID versus DisplayID versus Objid</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-all-objects-in-vault/index.html">Explore all the objects in the vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-number-of-records-in-class/index.html">Get number of records in Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-objectchangehistory/index.html">Working with object change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started-with-a-custom-application/index.html">Getting started with a custom application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-to-know-mfsql-connector/index.html">Getting to know MFSQL Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto-quick-follow-up-list/index.html">How to generate a quick follow up list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../illegal-xml-characters/index.html">Illegal XML Characters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../import-files-into-m-files-from-explorer/index.html">Import files into M-Files from explorer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../importing-files-from-a-database/index.html">Importing files from a database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../insert-new-records-from-sql/index.html">Insert new records from SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-whitepaper/index.html">Integration whitepaper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-sage-200---case-management/index.html">Integration with SAGE 200 - Case Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-sage-50/index.html">Integration with SAGE 50</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-test-equipment/index.html">Integration with test equipment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-vendor-management-and-purchasing-with-epicor-enterprise/index.html">Integration with Vendor Management and Purchasing with Epicor Enterprise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mark-for-archiving-using-class-table/index.html">Mark for Archiving using Class Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata-management/index.html">Metadata Management and data cleansing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata_management_and_realignment/index.html">Metadata Management and Realignment Case Study</a></li>
<li class="toctree-l2"><a class="reference internal" href="../moving-documents-from-one-class-to-another/index.html">Moving documents from one class to another</a></li>
<li class="toctree-l2"><a class="reference internal" href="../moving-metadata-from-text-properties-to-valuelist-items/index.html">Moving metadata from text properties to Valuelist items</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multiselectlookups/index.html">MultiSelectLookups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../near-real-time-reporting/index.html">Near real time reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../online-ordering-of-special-stock/index.html">Online Ordering of special stock</a></li>
<li class="toctree-l2"><a class="reference internal" href="../online-quote-system/index.html">Online Quote System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing-scanned-documents/index.html">Processing scanned documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../properties-with-multi-lookup-datatypes/index.html">Properties with multi lookup datatypes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../real-datatype/index.html">Limitations of real datatype</a></li>
<li class="toctree-l2"><a class="reference internal" href="../report-designers-and-the-connector/index.html">Report designers and the Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reports-from-the-extended-event-log/index.html">Reports from the extended Event log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../restore-to-a-different-database/index.html">Restore MFSQL database to a different server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rpc-over-https/index.html">RPC over HTTPS setup</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Setting up a workflow state change</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setup-agent-proxy/index.html">Setup Agent Proxy for MFSQLConnect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../status-report-using-context-menu/index.html">Status report using context menu</a></li>
<li class="toctree-l2"><a class="reference internal" href="../table-relations---views-for-reporting/index.html">Table relations - views for reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../update-large-tables/index.html">Update large tables using batch mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-a-multi-lookup-property-on-an-object/index.html">Updating a multi lookup property on an object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-incorrect-properties-across-multiple-related-classes/index.html">Updating incorrect properties across multiple related classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-only-records-that-changed/index.html">Updating only records that changed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating_millions_of_records/index.html">Updating millions of records</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-delimiter-functions/index.html">Using delimiter functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-event-handler-for-sql-action/index.html">Using event handler for SQL action</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-hyperlinks-with-mfsql-connector/index.html">Using hyperlinks with MFSQL Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-m-files-external-connector/index.html">Using M-Files External Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-object-change-history-to-report-on-state-changes/index.html">Using object change history to report on state changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-spmfclasstablestats/index.html">Using spMFClassTableStats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-the-external_id-to-match-third-party-app-tables/index.html">Using the External_ID to match third party app tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../windows-authentication/index.html">Using windows authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_checkedout/index.html">Working with checkedOut objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_dates/index.html">Working with date and time</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_document_collections/index.html">Working with Document Collections</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">SQL Components:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../procedures/index.html">Procedures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tables/index.html">Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../functions/index.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../views/index.html">Views</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MFSQL Connector</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">List of blogs</a> &raquo;</li>
        
      <li>Setting up a workflow state change</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="setting-up-a-workflow-state-change">
<h1>Setting up a workflow state change<a class="headerlink" href="#setting-up-a-workflow-state-change" title="Permalink to this headline">¶</a></h1>
<p>This use case will illustrate how to setup an action to take place in
SQL based on a workflow state change.</p>
<blockquote>
<div><p>When the purchase invoice is approved, SQL must be updated with the
latest status of the object. It this use case only the specific
object must be updated.</p>
<p>An alternative method would be to update all changes in the class
for all objects. This is a different method requiring a slightly
different approach.</p>
</div></blockquote>
<p>This operation is part of the Context Menu functionality of the
Connector and depends on the installation of the Context Menu in the
Vault. Note that this functionality is not available for deployments
where the M-Files server and the SQL Server is not in the same domain.</p>
<p>This is method is particularly useful when a workflow event in M-Files
must trigger a background operation such as:</p>
<ul class="simple">
<li><p>updating M-Files records into SQL for reporting or further processing</p></li>
<li><p>triggering an operation into or from a third party application</p></li>
<li><p>performing a complex operation on the object being changed or any
other object that can be derived from the user action.</p></li>
</ul>
<p>This use case will illustrate settings up an update to a class table for
a specific object when the state is changed.</p>
<p>Different parts of the connector are being used in this use case and
familiarity with the following is required:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../procedures/spMFDropAndUpdateMetadata.html"><span class="doc">spMFDropAndUpdateMetadata</span></a> (to update the configuration changes in
M-Files)</p></li>
<li><p><a class="reference internal" href="../../procedures/spMFCreateTable.html"><span class="doc">spMFCreateTable</span></a> (to create the class table)</p></li>
<li><p>MFPurchaseInvoice (the class table)</p></li>
<li><p><a class="reference internal" href="../../tables/tbMFContextMenu.html"><span class="doc">MFContextMenu</span></a> (the rules table for context menu operations)</p></li>
<li><p><a class="reference internal" href="../../procedures/spMFContextMenuHeadingItem.html"><span class="doc">spMFContextMenuHeadingItem</span></a> (to add heading)</p></li>
<li><p><a class="reference internal" href="../../procedures/spMFContextMenuActionItem.html"><span class="doc">spMFContextMenuActionItem</span></a> (to add action)</p></li>
<li><p>custom.CMDoObjectActionForWorkflowState (serves as template for
setting up procedure)</p></li>
<li><p><a class="reference internal" href="../../procedures/spMFUpdateTable.html"><span class="doc">spMFUpdateTable</span></a> (to update object into SQL)</p></li>
<li><p>VB script of state change actions (template to be used)</p></li>
</ul>
<hr class="docutils" />
<p>Step 1: M-Files vault updates</p>
<p>Determine the class of object that will be used for the workflow state
action. In the use case it is Purchase Invoices.</p>
<p><img alt="image0" src="../../_images/img_15.jpg" /></p>
<p>Assign a workflow to the class. Determine the workflow state that will
be used to action a SQL procedure.</p>
<p>In our example the workflow for the class is Release and accepting
purchase invoices and the state is Approved</p>
<p><img alt="image1" src="../../_images/img_24.jpg" /></p>
<p>When the user update the workflow state to approved, the expectation is
the object will be updated SQL to show the latest data of the object.</p>
<p>Step 2:</p>
<p>Update the metadata structure in SQL if any changes where made to the
structure.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFDropAndUpdateMetadata</span><span class="p">]</span>
</pre></div>
</div>
<p>Step 3:</p>
<p>Create the class table in SQL and update the table from M-Files to SQL</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFCreateTable</span><span class="p">]</span> <span class="o">@</span><span class="n">ClassName</span> <span class="o">=</span> <span class="s1">&#39;Purchase invoice&#39;</span>

<span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFUpdateTable</span><span class="p">]</span> <span class="o">@</span><span class="n">MFTableName</span> <span class="o">=</span> <span class="s1">&#39;MFPurchaseInvoice&#39;</span><span class="p">,</span>    <span class="c1">-- nvarchar(200)</span>
                             <span class="o">@</span><span class="n">UpdateMethod</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Step 4:</p>
<p>Create the custom procedure to for the action to be performed. In this
case the object should pull and update from M-Files to SQL for the
specific object.</p>
<p>It is good practice to first create and debug to code snippet that will
perform the action, and then to build it into the framework.</p>
<p>We will use the additional parameters in the spmfupdatetable procedure
to achieve the objective. When executed the procedure must update for
the specific object.</p>
<p>We will also introduce to use of error trapping and logging for messages
and back tracking when setting up the procedure.</p>
<p>First setup a select statement to review the object to be updated</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="p">[</span><span class="n">mpi</span><span class="p">].[</span><span class="n">ObjID</span><span class="p">],</span>
       <span class="p">[</span><span class="n">mpi</span><span class="p">].[</span><span class="n">MFVersion</span><span class="p">],</span>
       <span class="p">[</span><span class="n">mpi</span><span class="p">].[</span><span class="n">Workflow_State</span><span class="p">],</span>
       <span class="o">*</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFPurchaseInvoice</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mpi</span><span class="p">]</span>
<span class="k">WHERE</span> <span class="p">[</span><span class="n">mpi</span><span class="p">].[</span><span class="n">ObjID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">360</span>
</pre></div>
</div>
<p>The result - before the update:</p>
<p><img alt="image2" src="../../_images/img_31.jpg" /></p>
<p>Make the change in M-Files. Then run the update statement.</p>
<p>Note the following:</p>
<ul class="simple">
<li><p>We will be passing in the objid when this snippet is connected to the
action. We therefore setup an input parameter for the objid as an
integer.</p></li>
<li><p>spMFupdatetable allows for a comma delimited string of objid’s to be
passed to M-Files. It will only perform the update operation for the
list of objid’s. In the example we will pass a single objid to the
procedure but it need to be converted to a string.</p></li>
<li><p>Using the &#64;Update_IDOut and &#64;ProcessBatch_ID allows for viewing the
logging results of the process which is taking place in the
background. This is helpful for backtracking and debugging.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DECLARE</span> <span class="o">@</span><span class="n">Update_IDOut</span> <span class="nb">INT</span><span class="p">,</span> <span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="nb">INT</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">Objid</span> <span class="nb">INT</span><span class="p">,</span> <span class="o">@</span><span class="n">Objids_string</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>

<span class="k">SET</span> <span class="o">@</span><span class="n">objid</span> <span class="o">=</span> <span class="mi">360</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">objids_string</span> <span class="o">=</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">objid</span> <span class="k">AS</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFUpdateTable</span><span class="p">]</span> <span class="o">@</span><span class="n">MFTableName</span> <span class="o">=</span> <span class="s1">&#39;MFPurchaseInvoice&#39;</span><span class="p">,</span>
                             <span class="o">@</span><span class="n">UpdateMethod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="o">@</span><span class="n">ObjIDs</span> <span class="o">=</span> <span class="o">@</span><span class="n">Objids_string</span><span class="p">,</span>
                             <span class="o">@</span><span class="n">Update_IDOut</span> <span class="o">=</span> <span class="o">@</span><span class="n">Update_IDOut</span> <span class="k">OUTPUT</span><span class="p">,</span>
                             <span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="o">=</span> <span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="k">OUTPUT</span>

<span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFUpdateHistoryShow</span><span class="p">]</span> <span class="o">@</span><span class="n">Update_ID</span> <span class="o">=</span> <span class="o">@</span><span class="n">Update_IDOut</span><span class="p">,</span>
                                   <span class="o">@</span><span class="n">IsSummary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                   <span class="o">@</span><span class="n">UpdateColumn</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFProcessBatchDetail</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mpbd</span><span class="p">]</span> <span class="k">WHERE</span> <span class="p">[</span><span class="n">mpbd</span><span class="p">].[</span><span class="n">ProcessBatch_ID</span><span class="p">]</span> <span class="o">=</span> <span class="o">@</span><span class="n">ProcessBatch_ID</span>
</pre></div>
</div>
<p>After the update has been performed and the operation to be actions has
been tested the result can be reviews. The expectation is to see an
increase in the object version with the new workflow state showing.</p>
<p><img alt="image3" src="../../_images/img_41.jpg" /></p>
<p>Step 5:</p>
<p>The targeted operation can now be built into the framework to allow for
the operation to be triggered when the state change takes place.</p>
<p>The installation include a number of sample procedures that can be used
as a starting point for this step.</p>
<p>Select the procedure: custom.CMDoObjectActionForWorkflowState from ssms
object explorer.</p>
<p><img alt="image4" src="../../_images/img_5.jpg" /></p>
<p>right click on the object and then select the options to create a new
query from existing</p>
<p><img alt="image5" src="../../_images/img_6.jpg" /></p>
<p>Rename the new procedure to be created, and save the script for later
reuse. Good practice is to:</p>
<ul class="simple">
<li><p>use the custom schema for all custom procedures and tables.</p></li>
<li><p>Start with an action word (do)</p></li>
<li><p>Add the subject of the action (ApprovedPI)</p></li>
<li><p>Add the action (update)</p></li>
</ul>
<p>Don’t forget to also update the value of the parameter &#64;procedurename =
‘Your new procedure name’</p>
<p><img alt="image6" src="../../_images/img_7.jpg" /></p>
<p>We can now start to include the operation developed above into the
example script.</p>
<p>The sample procedure include three operations for the object. The
following comment lines is shown at the start of each of the operations:</p>
<ul class="simple">
<li><p>–get object from M-Files</p></li>
<li><p>–Perform action on/with object</p></li>
<li><p>–process update of object into M-Files</p></li>
</ul>
<p>The first operation - get object from M-Files is similar to the result
in step 4. In this case the only operation to be performed is to get the
new object. You can therefore delete the next two operations as they are
not required.</p>
<p>The next update is to review and change the user message. This can be
achieved by changing the set value of the &#64;Output parameter in the
section – set custom message to user.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- set custom message to user</span>

                  <span class="k">SET</span> <span class="o">@</span><span class="k">OutPut</span> <span class="o">=</span> <span class="o">@</span><span class="k">OutPut</span> <span class="o">+</span> <span class="s1">&#39; Object updated &#39;</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">ObjectID</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
</pre></div>
</div>
<p>Execute the procedure to save it in the database.</p>
<blockquote>
<div><p>Note the following special features and operations that is included
in the example and is now part of your procedure:</p>
<p>The input parameters for the procedure (&#64;objectID, &#64;ObjectType,
&#64;ObjectVer, &#64;ClassID) are all passed into this procedure by M-Files
when the action is called</p>
<p>The input parameter &#64;ID reference the id of the action item in the
MFContextMenu. (more about this later)</p>
<p>The output parameter &#64;output is the message that will be included in
the MFUserMessage table by default. (other alternatives are also
available)</p>
<p>The procedure will log operations to the MFprocessBatch and
MFProcessBatchDetail tables. This can be modified.</p>
<p>The WAITFOR DELAY statement must not be removed. This allows for the
object to be checked in before the update to SQL takes place. Note
that the timeframe (in seconds) can be modified to suite the
specific requirements.</p>
<p>The spMFResultMessageForUI controls the nature and content of the
user message. There are various options for this. The default is a
update message in the MFUserMessage table which is visible in
M-Files.</p>
</div></blockquote>
<p>Step 6:</p>
<p>Next step is to setup context menu to enable to procedure to be called
from M-Files. It has two parts:</p>
<ol class="arabic simple">
<li><p>Add entries to MFContextMenu</p></li>
<li><p>Add VB script to workflow state action.</p></li>
</ol>
<p>We recommend to use the example script 07.101 Updating the Context Menu.
This script is included in the installation and can be found in
installation folder: C:\Program Files (x86)\Laminin Solutions\MFSQL
Connector Release 4\[Your database]\Example Scripts</p>
<p>Using this script you will add a context menu action item with the
following parameters:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFContextMenuActionItem</span><span class="p">]</span>
<span class="o">@</span><span class="n">ActionName</span> <span class="o">=</span> <span class="s1">&#39;Approved state update for PI&#39;</span> <span class="p">,</span>
<span class="o">@</span><span class="n">ProcedureName</span> <span class="o">=</span> <span class="s1">&#39;Custom.DoApprovedPIUpdate&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">Description</span> <span class="o">=</span> <span class="s1">&#39;Procedure for state action to update object&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">RelatedMenu</span> <span class="o">=</span> <span class="s1">&#39;Asynchronous Actions&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">IsRemove</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="o">@</span><span class="n">IsObjectContext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="o">@</span><span class="n">IsWeblink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="o">@</span><span class="n">IsAsynchronous</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="o">@</span><span class="n">IsStateAction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="o">@</span><span class="n">PriorAction</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
<span class="o">@</span><span class="n">UserGroup</span> <span class="o">=</span> <span class="s1">&#39;All Internal users&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">Debug</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>The result is in the MFContextMenu</p>
<p>The final step is to add the VB script into the workflow state. This is
done in M-Files Admin</p>
<p>Use the following VB script (also available in the <a class="reference internal" href="../../mfsql-data-exchange-and-reporting-connector/using-the-context-menu/index.html"><span class="doc">Using the Context Menu</span></a></p>
<div class="highlight-vbscript notranslate"><div class="highlight"><pre><span></span><span class="k">Option</span><span class="w"> </span><span class="k">Explicit</span><span class="w"></span>

<span class="kd">Dim</span><span class="w"> </span><span class="nv">ClassID</span><span class="w"></span>
<span class="n">ClassID</span><span class="o">=</span><span class="w"> </span><span class="n">Vault</span><span class="p">.</span><span class="n">ObjectPropertyoperations</span><span class="p">.</span><span class="n">GetProperty</span><span class="p">(</span><span class="n">ObjVer</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">).</span><span class="n">value</span><span class="p">.</span><span class="n">GetLookupID</span><span class="w"></span>

<span class="kd">Dim</span><span class="w"> </span><span class="nv">strInput</span><span class="w"></span>
<span class="n">strInput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;{&quot;&quot;ObjectID&quot;&quot;  : &quot;</span><span class="o">&amp;</span><span class="n">ObjVer</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="o">&amp;</span><span class="s2">&quot;, &quot;&quot;ObjectType&quot;&quot;  : &quot;</span><span class="o">&amp;</span><span class="n">ObjVer</span><span class="p">.</span><span class="n">Type</span><span class="w"> </span><span class="o">&amp;</span><span class="s2">&quot;, &quot;&quot;Objectver&quot;&quot;  : &quot;</span><span class="o">&amp;</span><span class="n">ObjVer</span><span class="p">.</span><span class="n">Version</span><span class="o">&amp;</span><span class="s2">&quot;,&quot;&quot;ClassID&quot;&quot;  : &quot;</span><span class="o">&amp;</span><span class="n">ClassID</span><span class="o">&amp;</span><span class="s2">&quot;, &quot;&quot;ActionName&quot;&quot;  : &quot;&quot;StateAction2&quot;&quot;, &quot;&quot;ActionTypeID&quot;&quot;: &quot;&quot;5&quot;&quot;}&quot;</span><span class="w"></span>

<span class="kd">Dim</span><span class="w"> </span><span class="nv">strOutput</span><span class="w"></span>
<span class="n">strOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vault</span><span class="p">.</span><span class="n">ExtensionMethodOperations</span><span class="p">.</span><span class="n">ExecuteVaultExtensionMethod</span><span class="p">(</span><span class="s2">&quot;PerformActionMethod&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strInput</span><span class="p">)</span><span class="w"></span>

<span class="c1">&#39;Err.Raise MfScriptCancel, strOutput</span><span class="w"></span>
</pre></div>
</div>
<p>Copy and past the script to the workflow state (Approved) / option
Actions/ Run Script. The only change to make is to set the procedure
that will be updated. Navigate the right and change the default to the
action name in MFContextMenu</p>
<p><img alt="image7" src="../../_images/img_8.jpg" /></p>
<p>Step 7:</p>
<p>The next step is to test the entire procedure that would be called by
the action script.</p>
<p>Change the workflow to the desired state in M-Files. Note that the
update will take approx. 1 minute (the time set in the WAITFOR DELAY).
then check SQL to see if the update took place.</p>
<p>Step 8:</p>
<p>Debugging tips:</p>
<p>Check the MFContextMenu to see if the process was triggered by M-Files.</p>
<ul class="simple">
<li><p>If IsProcessRunning = 1 and Last_Executed_Date = when to action was
performed then the trigger is working fine, but the procedure failed.</p>
<ul>
<li><p>Else the trigger has failed.</p></li>
</ul>
</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="p">[</span><span class="n">mcm</span><span class="p">].[</span><span class="n">ID</span><span class="p">],</span>
       <span class="p">[</span><span class="n">mcm</span><span class="p">].[</span><span class="n">ActionName</span><span class="p">],</span>
       <span class="p">[</span><span class="n">mcm</span><span class="p">].[</span><span class="n">IsProcessRunning</span><span class="p">],</span>
       <span class="p">[</span><span class="n">mcm</span><span class="p">].[</span><span class="n">Last_Executed_By</span><span class="p">],</span>
       <span class="p">[</span><span class="n">mcm</span><span class="p">].[</span><span class="n">Last_Executed_Date</span><span class="p">],</span>
       <span class="p">[</span><span class="n">mcm</span><span class="p">].[</span><span class="n">ActionUser_ID</span><span class="p">]</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFContextMenu</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mcm</span><span class="p">]</span>
</pre></div>
</div>
<p>Possible causes for trigger that is failing:</p>
<ul class="simple">
<li><p>Context menu is not correctly installed, or cannot connect</p></li>
</ul>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../setup-agent-proxy/index.html" class="btn btn-neutral float-right" title="Setup Agent Proxy for MFSQLConnect" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../rpc-over-https/index.html" class="btn btn-neutral float-left" title="RPC over HTTPS setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Laminin Solutions Ltd

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>