

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using object change history to report on state changes &mdash; MFSQL Connector 4.9.27.69 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/MFSQL-Favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Using spMFClassTableStats" href="../using-spmfclasstablestats/index.html" />
    <link rel="prev" title="Using M-Files External Connector" href="../using-m-files-external-connector/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> MFSQL Connector
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">FAQ:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Frequently asked questions</a></li>
</ul>
<p class="caption"><span class="caption-text">MFSQL Connector Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction to MFSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-data-exchange-and-reporting-connector/index.html">MFSQL Data Exchange and reporting Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-database-file-connector/index.html">MFSQL Database File Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-integration-connector/index.html">MFSQL Integration Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../the-connector-framework/index.html">The Connector Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../version-control/index.html">Version Control</a></li>
</ul>
<p class="caption"><span class="caption-text">Blog:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">List of blogs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../advanced-updating-of-valuelists-from-external-source/index.html">Advanced updating of Valuelists from external source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../align-metadata-from-an-external-source-with-data-in-m-files/index.html">Align metadata from an external source with data in M-Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aligning-valuelist-items-with-different-owners/index.html">Aligning valuelist items with different owners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../building-applications-around-m-files/index.html">Building applications around M-Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../certified-application-developer-presentation/index.html">Certified Application Developer presentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changing-class-of-object/index.html">Changing the class of an object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changing-from-single-lookup-to-multi-lookup/index.html">Changing from single lookup to multi lookup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../considerations-for-deleted-records/index.html">Considerations for deleted records</a></li>
<li class="toctree-l2"><a class="reference internal" href="../considerations-for-large-volume-vault/index.html">Considerations for large volume vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="../create-a-scheduled-pull-from-m-files-using-sql-server-agent/index.html">Create a scheduled pull from M-Files using SQL Server Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../creating-and-using-public-shared-link/index.html">Creating and using public shared link</a></li>
<li class="toctree-l2"><a class="reference internal" href="../creating-multiple-related-objects-on-file-import/index.html">Creating multiple related objects on file import</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crm-and-emailer-management/index.html">CRM and Emailer Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deleting-duplicate-objects/index.html">Deleting duplicate objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explore-object-versions/index.html">Explore Object History Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extended-reporting/index.html">Extended Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../externalid-displayid-objid/index.html">ExternalID versus DisplayID versus Objid</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-all-objects-in-vault/index.html">Explore all the objects in the vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-number-of-records-in-class/index.html">Get number of records in Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-objectchangehistory/index.html">Working with object change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started-with-a-custom-application/index.html">Getting started with a custom application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-to-know-mfsql-connector/index.html">Getting to know MFSQL Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto-quick-follow-up-list/index.html">How to generate a quick follow up list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../illegal-xml-characters/index.html">Illegal XML Characters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../import-files-into-m-files-from-explorer/index.html">Import files into M-Files from explorer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../importing-files-from-a-database/index.html">Importing files from a database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../insert-new-records-from-sql/index.html">Insert new records from SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-whitepaper/index.html">Integration whitepaper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-sage-200---case-management/index.html">Integration with SAGE 200 - Case Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-sage-50/index.html">Integration with SAGE 50</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-test-equipment/index.html">Integration with test equipment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-vendor-management-and-purchasing-with-epicor-enterprise/index.html">Integration with Vendor Management and Purchasing with Epicor Enterprise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mark-for-archiving-using-class-table/index.html">Mark for Archiving using Class Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata-management/index.html">Metadata Management and data cleansing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata_management_and_realignment/index.html">Metadata Management and Realignment Case Study</a></li>
<li class="toctree-l2"><a class="reference internal" href="../moving-documents-from-one-class-to-another/index.html">Moving documents from one class to another</a></li>
<li class="toctree-l2"><a class="reference internal" href="../moving-metadata-from-text-properties-to-valuelist-items/index.html">Moving metadata from text properties to Valuelist items</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multiselectlookups/index.html">MultiSelectLookups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../near-real-time-reporting/index.html">Near real time reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../online-ordering-of-special-stock/index.html">Online Ordering of special stock</a></li>
<li class="toctree-l2"><a class="reference internal" href="../online-quote-system/index.html">Online Quote System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing-scanned-documents/index.html">Processing scanned documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../properties-with-multi-lookup-datatypes/index.html">Properties with multi lookup datatypes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../real-datatype/index.html">Limitations of real datatype</a></li>
<li class="toctree-l2"><a class="reference internal" href="../report-designers-and-the-connector/index.html">Report designers and the Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reports-from-the-extended-event-log/index.html">Reports from the extended Event log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../restore-to-a-different-database/index.html">Restore MFSQL database to a different server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rpc-over-https/index.html">RPC over HTTPS setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setting-up-a-workflow-state-change/index.html">Setting up a workflow state change</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setup-agent-proxy/index.html">Setup Agent Proxy for MFSQLConnect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../status-report-using-context-menu/index.html">Status report using context menu</a></li>
<li class="toctree-l2"><a class="reference internal" href="../table-relations---views-for-reporting/index.html">Table relations - views for reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../update-large-tables/index.html">Update large tables using batch mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-a-multi-lookup-property-on-an-object/index.html">Updating a multi lookup property on an object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-incorrect-properties-across-multiple-related-classes/index.html">Updating incorrect properties across multiple related classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-only-records-that-changed/index.html">Updating only records that changed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating_millions_of_records/index.html">Updating millions of records</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-delimiter-functions/index.html">Using delimiter functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-event-handler-for-sql-action/index.html">Using event handler for SQL action</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-hyperlinks-with-mfsql-connector/index.html">Using hyperlinks with MFSQL Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-m-files-external-connector/index.html">Using M-Files External Connector</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using object change history to report on state changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-spmfclasstablestats/index.html">Using spMFClassTableStats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-the-external_id-to-match-third-party-app-tables/index.html">Using the External_ID to match third party app tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../windows-authentication/index.html">Using windows authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_checkedout/index.html">Working with checkedOut objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_dates/index.html">Working with date and time</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_document_collections/index.html">Working with Document Collections</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">SQL Components:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../procedures/index.html">Procedures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tables/index.html">Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../functions/index.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../views/index.html">Views</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MFSQL Connector</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">List of blogs</a> &raquo;</li>
        
      <li>Using object change history to report on state changes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-object-change-history-to-report-on-state-changes">
<h1>Using object change history to report on state changes<a class="headerlink" href="#using-object-change-history-to-report-on-state-changes" title="Permalink to this headline">¶</a></h1>
<p>In this use case a report is required to show who and when did a state
change take place for a specific object.</p>
<p>Several MFSQL Connector Tables and procedures will come into play:</p>
<ul class="simple">
<li><p>The Class table for the objects (e.g. MFPurchaseInvoice)</p></li>
<li><p>MFObjectChangeHistory</p></li>
<li><p>spMFGetHistory</p></li>
</ul>
<p>The helper example <strong>04.171.Get workflow state changes using Change
History.sql</strong> available in the installation folder is used as a starting
point.</p>
<hr class="docutils" />
<p>The procedure (spMFGetHistory) will extract the version history for a
M-Files property in a class with the following steps:</p>
<ol class="arabic simple">
<li><p>Set the process_id = 5 for the records to be included in the extract
on the target class table.</p></li>
<li><p>Execute spMFGetHistory with the filters will update/insert the change
history in the table MFObjectChangeHistory.</p></li>
<li><p>Use a select statement with a join between the class table and the
change history table to prepare the reporting data.</p></li>
</ol>
<p>Additional joins may be necessary when the change history property is a
valuelist or a state change. The following example will illustrate it.</p>
<hr class="docutils" />
<p>This use case will use the Purchase Invoice class in the sample vault
and show the state changes for approval of the invoices.</p>
<p>Set the process_id for the records to be included. In this case only
invoices that is approved or paid will be included.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFPurchaseInvoice</span><span class="p">]</span>
<span class="k">SET</span> <span class="p">[</span><span class="n">Process_ID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">WHERE</span> <span class="n">workflow_state</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;Approved&#39;</span><span class="p">,</span><span class="s1">&#39;Paid&#39;</span> <span class="p">)</span>
</pre></div>
</div>
<p>Process the extract of the history. In this case the full history for
the selected records have been set as the filters. Note that other
filters and parameters may apply in different circumstances. Refer to
the <a class="reference internal" href="../../procedures/spMFGetHistory.html"><span class="doc">spMFGetHistory</span></a> for
more detail.</p>
<p>The extract will insert/update the history records in the
MFObjectChangeHistory table.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFGetHistory</span><span class="p">]</span> <span class="o">@</span><span class="n">MFTableName</span> <span class="o">=</span> <span class="s1">&#39;MfPurchaseInvoice&#39;</span><span class="p">,</span>
                            <span class="o">@</span><span class="n">Process_id</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                            <span class="o">@</span><span class="n">ColumnNames</span> <span class="o">=</span> <span class="s1">&#39;Workflow_State&#39;</span><span class="p">,</span>
                            <span class="o">@</span><span class="n">IsFullHistory</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>The MFObjectChangeHistory table includes the history extracts across
all classes and properties. In the illustration below the individual
changes for each version of the object 361 of class 2 for the property
39 is an id of the of the property 39. The change has taken place on the
lastModifiedUtc date and time by user in MFlastModifiedBy_ID.</p>
<p>In other words: The class Purchase Invoice (2) and the object ‘Invoice
#1035 - Fortney Nolte Associates’ (361) was changed on 2010-06-23
11:59:54.000 by KimberleyM to workflowstate Checked, awaiting approval.</p>
<p><img alt="image0" src="../../_images/img_19.jpg" /></p>
<p>There are several critical joins to take into account:</p>
<ol class="arabic simple">
<li><p>The main join is between the class table (MFPurchaseInvoice) and
MFObjectChangeHistory. Note this join should always include both
class_id and Objid.</p></li>
<li><p>The MFUserAccount join is only included to get the name of the user
that performed the change. Note that MFLoginAccount can also be used
to show the common name, or email address of the user. this could be
used to trigger an email notification for the change.</p></li>
<li><p>The MFWorkflowState join is to get the name of the state. In other
cases where the propertyValue refers to another object (e.g. Customer
id) or a valuelist id the joins should be with the source. Sources
could be another class table, MFValuelistItems, MFUserAccounts
depending on the property that is being reported on.</p></li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="p">[</span><span class="n">mpi</span><span class="p">].[</span><span class="n">Class_ID</span><span class="p">],</span>
       <span class="p">[</span><span class="n">mpi</span><span class="p">].[</span><span class="n">ObjID</span><span class="p">],</span>
       <span class="p">[</span><span class="n">moch</span><span class="p">].[</span><span class="n">MFVersion</span><span class="p">],</span>
    <span class="n">mua</span><span class="p">.[</span><span class="n">LoginName</span><span class="p">],</span>
       <span class="p">[</span><span class="n">mpi</span><span class="p">].[</span><span class="n">Name_Or_Title</span><span class="p">],</span>
       <span class="p">[</span><span class="n">moch</span><span class="p">].[</span><span class="n">Property_Value</span><span class="p">],</span>
    <span class="n">mws</span><span class="p">.[</span><span class="n">Name</span><span class="p">]</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFPurchaseInvoice</span><span class="p">]</span> <span class="p">[</span><span class="n">mpi</span><span class="p">]</span>
    <span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFObjectChangeHistory</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">moch</span><span class="p">]</span>
        <span class="k">ON</span> <span class="p">[</span><span class="n">moch</span><span class="p">].[</span><span class="n">Class_ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpi</span><span class="p">].[</span><span class="n">Class_ID</span><span class="p">]</span>
           <span class="k">AND</span> <span class="p">[</span><span class="n">moch</span><span class="p">].[</span><span class="n">ObjID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpi</span><span class="p">].[</span><span class="n">ObjID</span><span class="p">]</span>
    <span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFUserAccount</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mua</span><span class="p">]</span>
        <span class="k">ON</span> <span class="p">[</span><span class="n">mua</span><span class="p">].[</span><span class="n">UserID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">moch</span><span class="p">].[</span><span class="n">MFLastModifiedBy_ID</span><span class="p">]</span>
    <span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFWorkflowState</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mws</span><span class="p">]</span>
        <span class="k">ON</span> <span class="p">[</span><span class="n">moch</span><span class="p">].[</span><span class="n">Property_Value</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mws</span><span class="p">].[</span><span class="n">MFID</span><span class="p">]</span>
<span class="k">WHERE</span> <span class="n">mpi</span><span class="p">.[</span><span class="n">ObjID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">361</span>
</pre></div>
</div>
<p>The result of the above select statement</p>
<p><img alt="image1" src="../../_images/img_27.jpg" /></p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../using-spmfclasstablestats/index.html" class="btn btn-neutral float-right" title="Using spMFClassTableStats" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../using-m-files-external-connector/index.html" class="btn btn-neutral float-left" title="Using M-Files External Connector" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Laminin Solutions Ltd

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>