

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using event handler for SQL action &mdash; MFSQL Connector 4.9.27.69 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/MFSQL-Favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Using hyperlinks with MFSQL Connector" href="../using-hyperlinks-with-mfsql-connector/index.html" />
    <link rel="prev" title="Using delimiter functions" href="../using-delimiter-functions/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> MFSQL Connector
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">FAQ:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Frequently asked questions</a></li>
</ul>
<p class="caption"><span class="caption-text">MFSQL Connector Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction to MFSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-data-exchange-and-reporting-connector/index.html">MFSQL Data Exchange and reporting Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-database-file-connector/index.html">MFSQL Database File Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mfsql-integration-connector/index.html">MFSQL Integration Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../the-connector-framework/index.html">The Connector Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../version-control/index.html">Version Control</a></li>
</ul>
<p class="caption"><span class="caption-text">Blog:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">List of blogs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../advanced-updating-of-valuelists-from-external-source/index.html">Advanced updating of Valuelists from external source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../align-metadata-from-an-external-source-with-data-in-m-files/index.html">Align metadata from an external source with data in M-Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aligning-valuelist-items-with-different-owners/index.html">Aligning valuelist items with different owners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../building-applications-around-m-files/index.html">Building applications around M-Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../certified-application-developer-presentation/index.html">Certified Application Developer presentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changing-class-of-object/index.html">Changing the class of an object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changing-from-single-lookup-to-multi-lookup/index.html">Changing from single lookup to multi lookup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../considerations-for-deleted-records/index.html">Considerations for deleted records</a></li>
<li class="toctree-l2"><a class="reference internal" href="../considerations-for-large-volume-vault/index.html">Considerations for large volume vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="../create-a-scheduled-pull-from-m-files-using-sql-server-agent/index.html">Create a scheduled pull from M-Files using SQL Server Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../creating-and-using-public-shared-link/index.html">Creating and using public shared link</a></li>
<li class="toctree-l2"><a class="reference internal" href="../creating-multiple-related-objects-on-file-import/index.html">Creating multiple related objects on file import</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crm-and-emailer-management/index.html">CRM and Emailer Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deleting-duplicate-objects/index.html">Deleting duplicate objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explore-object-versions/index.html">Explore Object History Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extended-reporting/index.html">Extended Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../externalid-displayid-objid/index.html">ExternalID versus DisplayID versus Objid</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-all-objects-in-vault/index.html">Explore all the objects in the vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-number-of-records-in-class/index.html">Get number of records in Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-objectchangehistory/index.html">Working with object change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started-with-a-custom-application/index.html">Getting started with a custom application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-to-know-mfsql-connector/index.html">Getting to know MFSQL Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto-quick-follow-up-list/index.html">How to generate a quick follow up list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../illegal-xml-characters/index.html">Illegal XML Characters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../import-files-into-m-files-from-explorer/index.html">Import files into M-Files from explorer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../importing-files-from-a-database/index.html">Importing files from a database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../insert-new-records-from-sql/index.html">Insert new records from SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-whitepaper/index.html">Integration whitepaper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-sage-200---case-management/index.html">Integration with SAGE 200 - Case Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-sage-50/index.html">Integration with SAGE 50</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-test-equipment/index.html">Integration with test equipment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integration-with-vendor-management-and-purchasing-with-epicor-enterprise/index.html">Integration with Vendor Management and Purchasing with Epicor Enterprise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mark-for-archiving-using-class-table/index.html">Mark for Archiving using Class Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata-management/index.html">Metadata Management and data cleansing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata_management_and_realignment/index.html">Metadata Management and Realignment Case Study</a></li>
<li class="toctree-l2"><a class="reference internal" href="../moving-documents-from-one-class-to-another/index.html">Moving documents from one class to another</a></li>
<li class="toctree-l2"><a class="reference internal" href="../moving-metadata-from-text-properties-to-valuelist-items/index.html">Moving metadata from text properties to Valuelist items</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multiselectlookups/index.html">MultiSelectLookups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../near-real-time-reporting/index.html">Near real time reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../online-ordering-of-special-stock/index.html">Online Ordering of special stock</a></li>
<li class="toctree-l2"><a class="reference internal" href="../online-quote-system/index.html">Online Quote System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing-scanned-documents/index.html">Processing scanned documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../properties-with-multi-lookup-datatypes/index.html">Properties with multi lookup datatypes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../real-datatype/index.html">Limitations of real datatype</a></li>
<li class="toctree-l2"><a class="reference internal" href="../report-designers-and-the-connector/index.html">Report designers and the Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reports-from-the-extended-event-log/index.html">Reports from the extended Event log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../restore-to-a-different-database/index.html">Restore MFSQL database to a different server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rpc-over-https/index.html">RPC over HTTPS setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setting-up-a-workflow-state-change/index.html">Setting up a workflow state change</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setup-agent-proxy/index.html">Setup Agent Proxy for MFSQLConnect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../status-report-using-context-menu/index.html">Status report using context menu</a></li>
<li class="toctree-l2"><a class="reference internal" href="../table-relations---views-for-reporting/index.html">Table relations - views for reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../update-large-tables/index.html">Update large tables using batch mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-a-multi-lookup-property-on-an-object/index.html">Updating a multi lookup property on an object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-incorrect-properties-across-multiple-related-classes/index.html">Updating incorrect properties across multiple related classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating-only-records-that-changed/index.html">Updating only records that changed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../updating_millions_of_records/index.html">Updating millions of records</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-delimiter-functions/index.html">Using delimiter functions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using event handler for SQL action</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-vendor-in-m-files-auto-create-in-third-party">Create vendor in M-Files, auto create in third party</a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-vendor-in-m-files-auto-update-in-third-party">Update Vendor in M-Files auto update in third party</a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-m-files-following-an-update-in-third-party-application">Update M-Files following an update in third party application.</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../using-hyperlinks-with-mfsql-connector/index.html">Using hyperlinks with MFSQL Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-m-files-external-connector/index.html">Using M-Files External Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-object-change-history-to-report-on-state-changes/index.html">Using object change history to report on state changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-spmfclasstablestats/index.html">Using spMFClassTableStats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-the-external_id-to-match-third-party-app-tables/index.html">Using the External_ID to match third party app tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../windows-authentication/index.html">Using windows authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_checkedout/index.html">Working with checkedOut objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_dates/index.html">Working with date and time</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working_with_document_collections/index.html">Working with Document Collections</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">SQL Components:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../procedures/index.html">Procedures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tables/index.html">Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../functions/index.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../views/index.html">Views</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MFSQL Connector</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">List of blogs</a> &raquo;</li>
        
      <li>Using event handler for SQL action</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-event-handler-for-sql-action">
<h1>Using event handler for SQL action<a class="headerlink" href="#using-event-handler-for-sql-action" title="Permalink to this headline">¶</a></h1>
<p>In this use case we would like to illustrate how an event handler can be
used to trigger an SQL procedure using the Context Menu functionality.</p>
<p>Refer to <a class="reference internal" href="../../mfsql-data-exchange-and-reporting-connector/using-the-context-menu/index.html"><span class="doc">Using the Context Menu</span></a>
for more detail on using and setting up context menu related functionality:</p>
<p>The actions to start an SQL procedure from M-Files can be called via
menu items, or workflow states or event handlers. This case highlights
the event handler method.</p>
<p>Event handlers is useful when a SQL operation must be initiated based on
the event handler trigger. For instance, if a new object must
automatically be created in the 3rd party system following the creation
of a new object in M-Files then the ‘AfterCreateNewObjectFinalize’ event
handler can be used to trigger the SQL procedure. When the action should
be performed after the object in M-Files was changed, then the
‘AfterCheckInChanges’ can be used.</p>
<p>Using event handlers should be considered carefully. Some of the risks
associated include:</p>
<ul class="simple">
<li><p>Negative impact on performance - The use of event handlers put
additional load on M-Files processing.</p></li>
<li><p>Clashes with other event handlers - compliance kit, Vault
applications and other event handlers could clash with each other.</p></li>
<li><p>Table locking - table or record locking could take place in the
thirdparty database, in MFSQL Connector database and M-Files.
Avoiding table locking, and corrective action when table locking has
taken place should be considered when designing the processes
triggered by the event handler.</p></li>
<li><p>Creating an infinite loop - If multiple event handlers are used in
MFSQL connector, and the one event handler automatically triggers
another event handler, which in turn triggers the originating event
handler then an infinite loop arose.</p></li>
<li><p>Update Precedence - when updates are automatically triggered from
both third party system and M-Files, special care should be taken to
isolate changes in both systems. This is likely to use staging tables
to broker the direction of update.</p></li>
</ul>
<p>In this use case we will demonstrate setting up the event handler and
context menu for creating a new object in the third party system on
finalising the creation of the object in M-Files. The use case will also
demonstrate the setup how to setup the event handler to update the third
party system from M-Files and get pull updates from the third party
system without causing and infinite loop.</p>
<hr class="docutils" />
<p>The configuration and custom work for building this case involve the
following key elements</p>
<ol class="arabic simple">
<li><p>Prepare custom procedure(s) to process updates. In our case we used a
single procedure for all four updates.</p>
<ol class="arabic simple">
<li><p>Third party insert</p></li>
<li><p>Third party update</p></li>
<li><p>M-Files insert</p></li>
<li><p>M-Files update</p></li>
</ol>
</li>
<li><p>Add Context menu actions</p></li>
<li><p>Configure event handler scripts</p></li>
</ol>
<p>Note the following:</p>
<ol class="arabic simple">
<li><p>Stop the event handler from re-processing updates by the third party
system by filtering out any updates by the MFSQL Connector user.</p></li>
<li><p>The custom procedure</p>
<ol class="arabic simple">
<li><p>Copy and use the custom.CMDoObjectActionForWorkFlowState procedure
as the framework for the new custom.DoVendorUpsert procedure</p></li>
<li><p>Update MF to SQL for the object before processing</p></li>
<li><p>Give precedence for the direction of update by using the action
type of the Context Menu to set the direction in the procedure</p></li>
<li><p>Use ‘Select’ statements with ‘Except’ to isolate only the changed
or new records.</p></li>
</ol>
</li>
<li><p>There is no need for a wait state in the procedure as the checkin of
the object will take place before the action is called</p></li>
<li></li>
</ol>
<div class="section" id="create-vendor-in-m-files-auto-create-in-third-party">
<h2>Create vendor in M-Files, auto create in third party<a class="headerlink" href="#create-vendor-in-m-files-auto-create-in-third-party" title="Permalink to this headline">¶</a></h2>
<p>Use AfterCreateNewObjectFinalize Event Handler with filter on the class
and the MFSQL Connector user.</p>
<p>Note that the following must be updated for your scenario:
VendorClassID; MFSQLConnectorUserID; ActionName</p>
<div class="highlight-vbscript notranslate"><div class="highlight"><pre><span></span><span class="k">Option</span><span class="w"> </span><span class="k">Explicit</span><span class="w"></span>

<span class="kd">Dim</span><span class="w"> </span><span class="nv">oProperties</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">Set</span><span class="w"> </span><span class="n">oProperties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vault</span><span class="p">.</span><span class="n">ObjectPropertyOperations</span><span class="p">.</span><span class="n">GetProperties</span><span class="p">(</span><span class="n">ObjVer</span><span class="p">)</span><span class="w"></span>

<span class="kd">Dim</span><span class="w"> </span><span class="nv">ClassID</span><span class="w"></span>
<span class="n">ClassID</span><span class="o">=</span><span class="w"> </span><span class="n">Vault</span><span class="p">.</span><span class="n">ObjectPropertyoperations</span><span class="p">.</span><span class="n">GetProperty</span><span class="p">(</span><span class="n">ObjVer</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">).</span><span class="n">value</span><span class="p">.</span><span class="n">GetLookupID</span><span class="w"></span>
<span class="kd">Dim</span><span class="w"> </span><span class="nv">LastModifiedUserID</span><span class="w"></span>
<span class="n">LastModifiedUserID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vault</span><span class="p">.</span><span class="n">ObjectPropertyoperations</span><span class="p">.</span><span class="n">GetProperty</span><span class="p">(</span><span class="n">ObjVer</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">).</span><span class="n">value</span><span class="p">.</span><span class="n">GetLookupID</span><span class="w"></span>

<span class="kd">Dim</span><span class="w"> </span><span class="nv">VendorClassID</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">VendorClassID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">61</span><span class="w"></span>
<span class="kd">Dim</span><span class="w"> </span><span class="nv">MFSQLConnectUserID</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">MFSQLConnectUserID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">41</span><span class="w"></span>

<span class="k">If</span><span class="w"> </span><span class="p">(</span><span class="n">VendorClassID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassID</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">LastModifiedUserID</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">MFSQLConnectUserID</span><span class="p">)</span><span class="w"> </span><span class="k">Then</span><span class="w"></span>

<span class="kd">Dim</span><span class="w"> </span><span class="nv">strInput</span><span class="w"></span>
<span class="n">strInput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;{&quot;&quot;ObjectID&quot;&quot;  : &quot;</span><span class="o">&amp;</span><span class="n">ObjVer</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="o">&amp;</span><span class="s2">&quot;, &quot;&quot;ObjectType&quot;&quot;  : &quot;</span><span class="o">&amp;</span><span class="n">ObjVer</span><span class="p">.</span><span class="n">Type</span><span class="w"> </span><span class="o">&amp;</span><span class="s2">&quot;, &quot;&quot;Objectver&quot;&quot;  : &quot;</span><span class="o">&amp;</span><span class="n">ObjVer</span><span class="p">.</span><span class="n">Version</span><span class="o">&amp;</span><span class="s2">&quot;,&quot;&quot;ClassID&quot;&quot;  : &quot;</span><span class="o">&amp;</span><span class="n">ClassID</span><span class="o">&amp;</span><span class="s2">&quot;, &quot;&quot;ActionName&quot;&quot;  : &quot;&quot;VendorEventAction&quot;&quot;, &quot;&quot;ActionTypeID&quot;&quot;: &quot;&quot;5&quot;&quot;}&quot;</span><span class="w"></span>

<span class="kd">Dim</span><span class="w"> </span><span class="nv">strOutput</span><span class="w"></span>
<span class="n">strOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vault</span><span class="p">.</span><span class="n">ExtensionMethodOperations</span><span class="p">.</span><span class="n">ExecuteVaultExtensionMethod</span><span class="p">(</span><span class="s2">&quot;PerformActionMethod&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strInput</span><span class="p">)</span><span class="w"></span>

<span class="c1">&#39;Err.Raise MfScriptCancel, strOutput</span><span class="w"></span>
<span class="k">End</span><span class="w"> </span><span class="k">If</span><span class="w"></span>
</pre></div>
</div>
<p>Create action record in the Context menu</p>
<p>Note ‘IsStateAction’ = 1; IsAsynchronous = 1</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFContextMenuActionItem</span><span class="p">]</span> <span class="o">@</span><span class="n">ActionName</span> <span class="o">=</span> <span class="s1">&#39;VendorEventAction&#39;</span><span class="p">,</span>      <span class="c1">-- nvarchar(100)</span>
                                       <span class="o">@</span><span class="n">ProcedureName</span> <span class="o">=</span> <span class="s1">&#39;custom.DoVendorUpsert&#39;</span><span class="p">,</span>   <span class="c1">-- nvarchar(100)</span>
                                       <span class="o">@</span><span class="n">Description</span> <span class="o">=</span> <span class="s1">&#39;Updating Vendors in ERP &#39;</span><span class="p">,</span>     <span class="c1">-- nvarchar(200)</span>
                                       <span class="o">@</span><span class="n">RelatedMenu</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>     <span class="c1">-- nvarchar(100)</span>
                                       <span class="o">@</span><span class="n">IsRemove</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>        <span class="c1">-- bit</span>
                                       <span class="o">@</span><span class="n">IsObjectContext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">-- bit</span>
                                       <span class="o">@</span><span class="n">IsWeblink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>       <span class="c1">-- bit</span>
                                       <span class="o">@</span><span class="n">IsAsynchronous</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1">-- bit</span>
                                       <span class="o">@</span><span class="n">IsStateAction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">-- bit</span>
                                       <span class="o">@</span><span class="n">PriorAction</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>     <span class="c1">-- nvarchar(100)</span>
                                       <span class="o">@</span><span class="n">UserGroup</span> <span class="o">=</span> <span class="s1">&#39;All Internal Users&#39;</span><span class="p">,</span>       <span class="c1">-- nvarchar(100)</span>
                                       <span class="o">@</span><span class="n">Debug</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1">-- int</span>
</pre></div>
</div>
<p>Snippets from the custom.DoVendorUpsert procedure</p>
<p>Creating new vendor in ERP</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span>
<span class="p">(</span>
    <span class="k">SELECT</span> <span class="mi">1</span>
    <span class="k">FROM</span> <span class="p">[</span><span class="n">NORTHWND</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Suppliers</span><span class="p">]</span>
        <span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mv</span><span class="p">]</span>
            <span class="k">ON</span> <span class="p">[</span><span class="n">SupplierID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">ExternalID</span><span class="p">]</span>
               <span class="k">AND</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">ObjID</span><span class="p">]</span> <span class="o">=</span> <span class="o">@</span><span class="n">ObjectID</span> <span class="k">AND</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Deleted</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span>
<span class="k">BEGIN</span>
    <span class="k">SET</span> <span class="o">@</span><span class="n">ProcedureStep</span> <span class="o">=</span> <span class="s1">&#39;Insert into ERP&#39;</span><span class="p">;</span>

    <span class="k">IF</span> <span class="o">@</span><span class="n">Debug</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">BEGIN</span>
        <span class="n">RAISERROR</span><span class="p">(</span><span class="o">@</span><span class="n">DebugText</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">@</span><span class="n">procedureName</span><span class="p">,</span> <span class="o">@</span><span class="n">ProcedureStep</span><span class="p">);</span>
    <span class="k">END</span><span class="p">;</span>

    <span class="c1">-------------------------------------------------------------</span>
    <span class="c1">-- Create new in ERP: will only create new item for the context object</span>
    <span class="c1">-------------------------------------------------------------</span>

 <span class="k">INSERT</span> <span class="k">INTO</span> <span class="p">[</span><span class="n">NORTHWND</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Suppliers</span><span class="p">]</span>
    <span class="p">(</span>
        <span class="p">[</span><span class="n">CompanyName</span><span class="p">]</span>
       <span class="p">,[</span><span class="n">Address</span><span class="p">]</span>
       <span class="p">,[</span><span class="n">City</span><span class="p">]</span>
       <span class="p">,[</span><span class="n">PostalCode</span><span class="p">]</span>

    <span class="p">)</span>
    <span class="k">SELECT</span>
        <span class="k">SUBSTRING</span><span class="p">([</span><span class="n">ma</span><span class="p">].[</span><span class="n">Name_Or_Title</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>                                   <span class="k">AS</span> <span class="p">[</span><span class="n">Company</span> <span class="n">Name</span><span class="p">]</span>
       <span class="p">,</span><span class="k">SUBSTRING</span><span class="p">(([</span><span class="n">ma</span><span class="p">].[</span><span class="n">Address_Line_1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="p">[</span><span class="n">ma</span><span class="p">].[</span><span class="n">Address_Line_2</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span> <span class="k">AS</span> <span class="p">[</span><span class="n">Address</span><span class="p">]</span>
       <span class="p">,</span><span class="k">SUBSTRING</span><span class="p">([</span><span class="n">ma</span><span class="p">].[</span><span class="n">City</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>                                            <span class="k">AS</span> <span class="p">[</span><span class="n">City</span><span class="p">]</span>
       <span class="p">,</span><span class="k">SUBSTRING</span><span class="p">([</span><span class="n">ma</span><span class="p">].[</span><span class="n">Postal_Code</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>                                     <span class="k">AS</span> <span class="p">[</span><span class="n">Postal</span><span class="p">]</span>

    <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">ma</span><span class="p">]</span>
    <span class="k">WHERE</span> <span class="p">[</span><span class="n">ma</span><span class="p">].[</span><span class="n">ObjID</span><span class="p">]</span> <span class="o">=</span> <span class="o">@</span><span class="n">ObjectID</span> <span class="k">AND</span> <span class="p">[</span><span class="n">ma</span><span class="p">].[</span><span class="n">Deleted</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">SET</span> <span class="o">@</span><span class="n">ExternalID</span> <span class="o">=</span>
    <span class="p">(</span>   <span class="k">SELECT</span> <span class="k">MAX</span><span class="p">([</span><span class="n">T</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">])</span>
        <span class="k">FROM</span> <span class="p">[</span><span class="n">NORTHWND</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Suppliers</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">T</span><span class="p">]</span>
    <span class="p">);</span>

    <span class="k">UPDATE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span>
    <span class="k">SET</span> <span class="p">[</span><span class="n">Process_ID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
       <span class="p">,[</span><span class="n">ExternalID</span><span class="p">]</span> <span class="o">=</span> <span class="o">@</span><span class="n">ExternalID</span>
    <span class="k">WHERE</span> <span class="p">[</span><span class="n">ObjID</span><span class="p">]</span> <span class="o">=</span> <span class="o">@</span><span class="n">ObjectID</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="update-vendor-in-m-files-auto-update-in-third-party">
<h2>Update Vendor in M-Files auto update in third party<a class="headerlink" href="#update-vendor-in-m-files-auto-update-in-third-party" title="Permalink to this headline">¶</a></h2>
<p>Use ‘AfterCheckinChanges’ event handler. Use the same script as above.</p>
<p>In our example only one procedure is used for all the update scenarios.
The same context menu record is therefore used for the action.</p>
<p>Add the following to the custom.DoVendorUpsert procedure</p>
<p>to get the Actiontype</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">@</span><span class="n">ActionType</span> <span class="o">=</span> <span class="p">[</span><span class="n">ActionType</span><span class="p">]</span> <span class="k">FROM</span> <span class="n">MFContextMenu</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="o">@</span><span class="n">ID</span>
</pre></div>
</div>
<p>The update code will only apply when the action is called from the event
handler</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span> <span class="c1">-------------------------------------------------------------</span>
       <span class="c1">-- Update ERP</span>
       <span class="c1">-------------------------------------------------------------</span>
       <span class="k">IF</span> <span class="o">@</span><span class="n">ActionType</span> <span class="o">=</span> <span class="mi">5</span>
 <span class="k">BEGIN</span>
       <span class="p">;</span>
 <span class="k">WITH</span> <span class="p">[</span><span class="n">cte</span><span class="p">]</span>
       <span class="k">AS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Name_Or_Title</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Address_Line_1</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">City</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Postal_Code</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">ExternalID</span><span class="p">]</span>
           <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mv</span><span class="p">]</span> <span class="k">where</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Deleted</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
           <span class="k">EXCEPT</span>
           <span class="k">SELECT</span> <span class="p">[</span><span class="n">s</span><span class="p">].[</span><span class="n">CompanyName</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">Address</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">City</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">PostalCode</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">]</span>
           <span class="k">FROM</span> <span class="p">[</span><span class="n">NORTHWND</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Suppliers</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">s</span><span class="p">])</span>
       <span class="k">UPDATE</span> <span class="p">[</span><span class="n">T</span><span class="p">]</span>
       <span class="k">SET</span>
 <span class="p">[</span><span class="n">T</span><span class="p">].[</span><span class="n">CompanyName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">].[</span><span class="n">Company</span> <span class="n">Name</span><span class="p">]</span>
          <span class="p">,[</span><span class="n">T</span><span class="p">].[</span><span class="n">Address</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">].[</span><span class="n">Address</span><span class="p">]</span>
          <span class="p">,[</span><span class="n">T</span><span class="p">].[</span><span class="n">City</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">].[</span><span class="n">City</span><span class="p">]</span>
          <span class="p">,[</span><span class="n">T</span><span class="p">].[</span><span class="n">PostalCode</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">].[</span><span class="n">Postal</span><span class="p">]</span>
<span class="c1">--    SELECT *</span>
       <span class="k">FROM</span>  <span class="p">[</span><span class="n">cte</span><span class="p">]</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">NORTHWND</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Suppliers</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">T</span><span class="p">]</span>
 <span class="k">ON</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">ExternalID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">]</span>
           <span class="k">INNER</span> <span class="k">JOIN</span>
           <span class="p">(</span>
               <span class="k">SELECT</span> <span class="k">CAST</span><span class="p">([</span><span class="n">ma</span><span class="p">].[</span><span class="n">ExternalID</span><span class="p">]</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>                                    <span class="k">AS</span> <span class="p">[</span><span class="n">CompanyID</span><span class="p">]</span>
                     <span class="p">,</span><span class="k">SUBSTRING</span><span class="p">([</span><span class="n">ma</span><span class="p">].[</span><span class="n">Name_Or_Title</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>                                   <span class="k">AS</span> <span class="p">[</span><span class="n">Company</span> <span class="n">Name</span><span class="p">]</span>
                     <span class="c1">--NULL,</span>
                     <span class="c1">--NULL,</span>
                     <span class="p">,</span><span class="k">SUBSTRING</span><span class="p">(([</span><span class="n">ma</span><span class="p">].[</span><span class="n">Address_Line_1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="p">[</span><span class="n">ma</span><span class="p">].[</span><span class="n">Address_Line_2</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span> <span class="k">AS</span> <span class="p">[</span><span class="n">Address</span><span class="p">]</span>
                     <span class="p">,</span><span class="k">SUBSTRING</span><span class="p">([</span><span class="n">ma</span><span class="p">].[</span><span class="n">City</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>                                            <span class="k">AS</span> <span class="p">[</span><span class="n">City</span><span class="p">]</span>
                     <span class="c1">--                       SUBSTRING([ma].[Account_State], 1, 15)                                   AS [region],</span>
                     <span class="p">,</span><span class="k">SUBSTRING</span><span class="p">([</span><span class="n">ma</span><span class="p">].[</span><span class="n">Postal_Code</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>                                     <span class="k">AS</span> <span class="p">[</span><span class="n">Postal</span><span class="p">]</span>
                     <span class="p">,</span><span class="k">SUBSTRING</span><span class="p">([</span><span class="n">ma</span><span class="p">].[</span><span class="n">Country</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>                                         <span class="k">AS</span> <span class="p">[</span><span class="n">country</span><span class="p">]</span>
               <span class="c1">--                       SUBSTRING([ma].[Phone], 1, 24)                                           AS [Phone],</span>
               <span class="c1">--                       SUBSTRING([ma].[Fax], 1, 24)                                             AS [Fax],</span>
               <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">ma</span><span class="p">]</span>
   <span class="k">WHERE</span> <span class="p">[</span><span class="n">ma</span><span class="p">].[</span><span class="n">Deleted</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
           <span class="p">)</span>                             <span class="k">AS</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
               <span class="k">ON</span> <span class="p">[</span><span class="n">T</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">].[</span><span class="n">CompanyID</span><span class="p">];</span>


       <span class="c1">-------------------------------------------------------------</span>
       <span class="c1">-- Update changes into ERP</span>
       <span class="c1">-------------------------------------------------------------</span>
       <span class="k">WITH</span> <span class="p">[</span><span class="n">cte</span><span class="p">]</span>
       <span class="k">AS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="p">[</span><span class="n">s</span><span class="p">].[</span><span class="n">CompanyName</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">Address</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">City</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">PostalCode</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">]</span>
           <span class="k">FROM</span> <span class="p">[</span><span class="n">NORTHWND</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Suppliers</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
           <span class="k">EXCEPT</span>
           <span class="k">SELECT</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Name_Or_Title</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Address_Line_1</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">City</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Postal_Code</span><span class="p">]</span>
                 <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">ExternalID</span><span class="p">]</span>
           <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span>  <span class="k">AS</span> <span class="p">[</span><span class="n">mv</span><span class="p">]</span> <span class="k">WHERE</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Deleted</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
       <span class="k">UPDATE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span>
       <span class="k">SET</span> <span class="p">[</span><span class="n">Process_ID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
          <span class="p">,[</span><span class="n">Name_Or_Title</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">CompanyName</span><span class="p">]</span>
          <span class="p">,[</span><span class="n">Address_Line_1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">Address</span><span class="p">]</span>
          <span class="p">,[</span><span class="n">City</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">City</span><span class="p">]</span>
          <span class="p">,[</span><span class="n">Postal_Code</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">PostalCode</span><span class="p">]</span>
       <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mv</span><span class="p">]</span>
           <span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">cte</span><span class="p">]</span>
               <span class="k">ON</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">ExternalID</span><span class="p">]</span>
   <span class="k">WHERE</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Deleted</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">END</span>
</pre></div>
</div>
</div>
<div class="section" id="update-m-files-following-an-update-in-third-party-application">
<h2>Update M-Files following an update in third party application.<a class="headerlink" href="#update-m-files-following-an-update-in-third-party-application" title="Permalink to this headline">¶</a></h2>
<p>An insert or update in the third party application can be triggered in
various ways</p>
<ul class="simple">
<li><p>Trigger on the third party table calling the MFSQL procedure</p></li>
<li><p>Action Menu in M-Files to pull updates by calling the MFSQL procedure
from M-Files</p></li>
<li><p>Scheduled agent in SQL to call the MFSQL procedure every so often.</p></li>
</ul>
<p>Our example is based on having an action Menu in M-Files. We will be
using a context sensitive menu. The action will use the same procedure
as above.</p>
<p>Create the menu heading and menu item.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFContextMenuHeadingItem</span><span class="p">]</span> <span class="o">@</span><span class="n">MenuName</span> <span class="o">=</span> <span class="s1">&#39;ERP Context Update&#39;</span><span class="p">,</span>            <span class="c1">-- nvarchar(100)</span>
                                        <span class="o">@</span><span class="n">PriorMenu</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>           <span class="c1">-- nvarchar(100)</span>
                                        <span class="o">@</span><span class="n">IsObjectContextMenu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">-- bit</span>
                                        <span class="o">@</span><span class="n">IsRemove</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>            <span class="c1">-- bit</span>
                                        <span class="o">@</span><span class="n">UserGroup</span> <span class="o">=</span> <span class="s1">&#39;All Internal Users&#39;</span><span class="p">,</span>          <span class="c1">-- nvarchar(100)</span>
                                        <span class="o">@</span><span class="n">Debug</span> <span class="o">=</span> <span class="mi">0</span>                <span class="c1">-- int</span>

<span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFContextMenuActionItem</span><span class="p">]</span> <span class="o">@</span><span class="n">ActionName</span> <span class="o">=</span> <span class="s1">&#39;Vendor Update&#39;</span><span class="p">,</span>      <span class="c1">-- nvarchar(100)</span>
                                       <span class="o">@</span><span class="n">ProcedureName</span> <span class="o">=</span> <span class="s1">&#39;custom.DoVendorUpsert&#39;</span><span class="p">,</span>   <span class="c1">-- nvarchar(100)</span>
                                       <span class="o">@</span><span class="n">Description</span> <span class="o">=</span> <span class="s1">&#39;Updating Vendors from ERP &#39;</span><span class="p">,</span>     <span class="c1">-- nvarchar(200)</span>
                                       <span class="o">@</span><span class="n">RelatedMenu</span> <span class="o">=</span> <span class="s1">&#39;ERP Context Update&#39;</span><span class="p">,</span>     <span class="c1">-- nvarchar(100)</span>
                                       <span class="o">@</span><span class="n">IsRemove</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>        <span class="c1">-- bit</span>
                                       <span class="o">@</span><span class="n">IsObjectContext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">-- bit</span>
                                       <span class="o">@</span><span class="n">IsWeblink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>       <span class="c1">-- bit</span>
                                       <span class="o">@</span><span class="n">IsAsynchronous</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1">-- bit</span>
                                       <span class="o">@</span><span class="n">IsStateAction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>   <span class="c1">-- bit</span>
                                       <span class="o">@</span><span class="n">PriorAction</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>     <span class="c1">-- nvarchar(100)</span>
                                       <span class="o">@</span><span class="n">UserGroup</span> <span class="o">=</span> <span class="s1">&#39;All Internal Users&#39;</span><span class="p">,</span>       <span class="c1">-- nvarchar(100)</span>
                                       <span class="o">@</span><span class="n">Debug</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1">-- int</span>
</pre></div>
</div>
<p>The menu is exposed when right click on the object in M-Files.</p>
<p><img alt="image0" src="../../_images/img_18.jpg" /><img alt="image1" src="../../_images/img_26.jpg" /></p>
<p>Add the following snippet to the custom.DoVendorUpsert procedure</p>
<p>Note that this code will only operate when the action is called from the
menu. This is important to ensure that the previous code for updating
M-Files changes to ERP does not overwrite the changes from ERP to
M-Files.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>   <span class="c1">-------------------------------------------------------------</span>
     <span class="c1">-- insert ERP to MF</span>
     <span class="c1">-------------------------------------------------------------</span>

<span class="k">IF</span> <span class="o">@</span><span class="n">ActionType</span> <span class="o">=</span> <span class="mi">3</span>
     <span class="k">BEGIN</span>
         <span class="k">SET</span> <span class="o">@</span><span class="n">ProcedureStep</span> <span class="o">=</span> <span class="s1">&#39;Insert into MF&#39;</span><span class="p">;</span>

         <span class="k">IF</span> <span class="o">@</span><span class="n">Debug</span> <span class="o">&gt;</span> <span class="mi">0</span>
         <span class="k">BEGIN</span>
             <span class="n">RAISERROR</span><span class="p">(</span><span class="o">@</span><span class="n">DebugText</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">@</span><span class="n">procedureName</span><span class="p">,</span> <span class="o">@</span><span class="n">ProcedureStep</span><span class="p">);</span>
         <span class="k">END</span><span class="p">;</span>

         <span class="k">WITH</span> <span class="p">[</span><span class="n">cte</span><span class="p">]</span>
         <span class="k">AS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="p">[</span><span class="n">s</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">]</span>
             <span class="k">FROM</span> <span class="p">[</span><span class="n">NORTHWND</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Suppliers</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
             <span class="k">EXCEPT</span>
             <span class="k">SELECT</span> <span class="p">[</span><span class="n">ExternalID</span><span class="p">]</span>
             <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span> <span class="n">mv</span>
 <span class="k">WHERE</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Deleted</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
         <span class="k">INSERT</span> <span class="k">INTO</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span>
         <span class="p">(</span>
             <span class="p">[</span><span class="n">Address_Line_1</span><span class="p">]</span>
            <span class="p">,[</span><span class="n">Address_Line_2</span><span class="p">]</span>
            <span class="p">,[</span><span class="n">City</span><span class="p">]</span>
            <span class="p">,[</span><span class="n">Country_ID</span><span class="p">]</span>
            <span class="p">,[</span><span class="n">Name_Or_Title</span><span class="p">]</span>
            <span class="p">,[</span><span class="n">Postal_Code</span><span class="p">]</span>
            <span class="p">,[</span><span class="n">Process_ID</span><span class="p">]</span>
            <span class="p">,[</span><span class="n">ExternalID</span><span class="p">]</span>
         <span class="p">)</span>
         <span class="k">SELECT</span> <span class="p">[</span><span class="n">s</span><span class="p">].[</span><span class="n">Address</span><span class="p">]</span>
               <span class="p">,</span><span class="k">NULL</span>
               <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">City</span><span class="p">]</span>
               <span class="p">,</span><span class="k">NULL</span>
               <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">CompanyName</span><span class="p">]</span>
               <span class="c1">--     ,[s].[ContactName]</span>
               <span class="c1">--     ,[s].[ContactTitle]</span>
               <span class="c1">--     ,[s].[Region]</span>
               <span class="c1">--      ,[s].[Country]</span>
               <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">PostalCode</span><span class="p">]</span>
               <span class="c1">--     ,[s].[Phone]</span>
               <span class="c1">--     ,[s].[Fax]</span>
               <span class="c1">--     ,[s].[HomePage]</span>
               <span class="p">,</span><span class="mi">1</span>
               <span class="p">,[</span><span class="n">cte</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">]</span>
         <span class="k">FROM</span> <span class="p">[</span><span class="n">NORTHWND</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Suppliers</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
             <span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">cte</span><span class="p">]</span>
                 <span class="k">ON</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">];</span>

         <span class="c1">-------------------------------------------------------------</span>
         <span class="c1">-- changes from ERP to SQL</span>
         <span class="c1">-------------------------------------------------------------</span>
         <span class="k">WITH</span> <span class="p">[</span><span class="n">cte</span><span class="p">]</span>
         <span class="k">AS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="p">[</span><span class="n">s</span><span class="p">].[</span><span class="n">CompanyName</span><span class="p">]</span>
                   <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">Address</span><span class="p">]</span>
                   <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">City</span><span class="p">]</span>
                   <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">PostalCode</span><span class="p">]</span>
                   <span class="p">,[</span><span class="n">s</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">]</span>
             <span class="k">FROM</span> <span class="p">[</span><span class="n">NORTHWND</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Suppliers</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
             <span class="k">EXCEPT</span>
             <span class="k">SELECT</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Name_Or_Title</span><span class="p">]</span>
                   <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Address_Line_1</span><span class="p">]</span>
                   <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">City</span><span class="p">]</span>
                   <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Postal_Code</span><span class="p">]</span>
                   <span class="p">,[</span><span class="n">mv</span><span class="p">].[</span><span class="n">ExternalID</span><span class="p">]</span>
             <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mv</span><span class="p">]</span> <span class="k">WHERE</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">Deleted</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
         <span class="k">UPDATE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span>
         <span class="k">SET</span> <span class="p">[</span><span class="n">Process_ID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="p">,[</span><span class="n">Name_Or_Title</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">CompanyName</span><span class="p">]</span>
            <span class="p">,[</span><span class="n">Address_Line_1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">Address</span><span class="p">]</span>
            <span class="p">,[</span><span class="n">City</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">City</span><span class="p">]</span>
            <span class="p">,[</span><span class="n">Postal_Code</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">PostalCode</span><span class="p">]</span>
         <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MFVendor</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">mv</span><span class="p">]</span>
             <span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">cte</span><span class="p">]</span>
                 <span class="k">ON</span> <span class="p">[</span><span class="n">cte</span><span class="p">].[</span><span class="n">SupplierID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mv</span><span class="p">].[</span><span class="n">ExternalID</span><span class="p">];</span>
     <span class="k">END</span><span class="p">;</span>
</pre></div>
</div>
<p>Finalise the process by updating the changes into M-Files</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spMFUpdateTable</span><span class="p">]</span> <span class="o">@</span><span class="n">MFTableName</span> <span class="o">=</span> <span class="o">@</span><span class="n">MFClassTable</span>
                            <span class="c1">-- nvarchar(128)</span>
                            <span class="p">,</span><span class="o">@</span><span class="n">UpdateMethod</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="c1">-- int</span>
                            <span class="p">,</span><span class="o">@</span><span class="n">Update_IDOut</span> <span class="o">=</span> <span class="o">@</span><span class="n">Update_ID</span> <span class="k">OUTPUT</span>
                            <span class="c1">-- int</span>
                            <span class="p">,</span><span class="o">@</span><span class="n">ProcessBatch_ID</span> <span class="o">=</span> <span class="o">@</span><span class="n">ProcessBatch_ID</span>
                            <span class="c1">-- int</span>
                            <span class="p">,</span><span class="o">@</span><span class="n">Debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../using-hyperlinks-with-mfsql-connector/index.html" class="btn btn-neutral float-right" title="Using hyperlinks with MFSQL Connector" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../using-delimiter-functions/index.html" class="btn btn-neutral float-left" title="Using delimiter functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Laminin Solutions Ltd

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>